<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Python Packaging: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
           
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Python Packaging
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Python Packaging
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Python Packaging
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-scripts-and-modules.html">1. Python Scripts and Modules</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-packages.html">2. From Modules to Packages</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-building-and-installing.html">3. Building and Installing Packages using setuptools</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-history-of-packaging.html">4. Extra: A History of Python Build Tools</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-publishing.html">5. Publishing our Python Packages</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-scripts-and-modules"><p>Content from <a href="01-scripts-and-modules.html">Python Scripts and Modules</a></p>
<hr>
<p> Last updated on 2023-01-17 | 
        
        <a href="https://github.com/LiamPattinson/python-packaging/edit/main/episodes/01-scripts-and-modules.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is a ‘module’ in Python? How does this differ from a
‘script’?</li>
<li>What are the benefits of modularising our Python code?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Introduce the example library used in this lesson.</li>
<li>Understand the limitations of scripts.</li>
<li>Understand what happens when we <code>import</code> something.</li>
<li>Learn how to convert a simple script into a reusable module.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="python-as-a-scripting-language"><h2 class="section-heading">Python as a Scripting Language<a class="anchor" aria-label="anchor" href="#python-as-a-scripting-language"></a>
</h2>
<hr class="half-width">
<p>Python is frequently used as a scripting language by scientists and
engineers due to its expressiveness, simplicity, and its rich ecosystem
of third-party libraries. In this context, a ‘script’ can be understood
as file containing Python commands that we might run on the command
line. This may be a linear series of simple expressions, but it can also
include functions and classes:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 my_script.py</span></code></pre>
</div>
<p>Throughout this course, we’ll develop an example library that might
be used for epidemiology modelling, though it isn’t necessary to
understand how this works in order to follow the course. We’ll begin
where many new Python projects start: with a simple script. This one
solves a SIR model, which models the number of Susceptible, Infected,
and Recovered individuals as a pathogen spreads through a population.
The general pattern of the code – set up inputs, solve a problem, plot
the results – should be familiar to those working in a data-oriented
field. It uses the popular plotting library <a href="https://matplotlib.org/stable/tutorials/index.html" class="external-link">Matplotlib</a>
to generate a figure.</p>

<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputs</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Total number of susceptible people at the start of an outbreak</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>pop_size <span class="op">=</span> <span class="dv">8000000</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Average no. of new infections per infected person per day</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>beta <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse of the average number of days taken to recover</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of days to run the simulation for</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>days <span class="op">=</span> <span class="dv">150</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of infected people at the start of the simulation</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>I_0 <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialise data</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> [] <span class="co"># Number of susceptible people each day</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>I <span class="op">=</span> [] <span class="co"># Number of infected people each day</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> [] <span class="co"># Number of recovered people each day</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>S.append(pop_size <span class="op">-</span> I_0)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>I.append(I_0)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>R.append(<span class="dv">0</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Solve model</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(days):</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get rate of change of S, I, and R</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    dS <span class="op">=</span> <span class="op">-</span> beta <span class="op">*</span> S[i] <span class="op">*</span> I[i] <span class="op">/</span> pop_size</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    dR <span class="op">=</span> gamma <span class="op">*</span> I[i]</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    dI <span class="op">=</span> <span class="op">-</span>(dS <span class="op">+</span> dR)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get values on next day</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    S.append(S[i] <span class="op">+</span> dS)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    I.append(I[i] <span class="op">+</span> dI)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    R.append(R[i] <span class="op">+</span> dR)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(S)), S, label<span class="op">=</span><span class="st">"S"</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(I)), I, label<span class="op">=</span><span class="st">"I"</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(R)), R, label<span class="op">=</span><span class="st">"R"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Time /days"</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Population"</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<p>If we save this script to the file <code>SIR_model_script.py</code>,
it can then be run from the command line as follows:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 SIR_model_script.py</span></code></pre>
</div>
<p>If everything works as expected, it should produce the following
result:</p>
<figure><img src="fig/SIR_model.png" alt="A plot generated by running the SIR model script" class="figure mx-auto d-block"><figcaption>SIR model results</figcaption></figure><p>So far so good, but there are some limitations to this coding
style.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Can you think of any drawbacks to writing scripts like the one shown
above? Think about the general structure of the code and how the user
interacts with it rather than the details of the implementation.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>There are many possible answers to this. Here are some examples:</p>
<ul>
<li>If the user wants to change the model inputs, they have to open the
script file and modify some lines of code before running again. This is
difficult to automate and it’s possible that the user might overwrite
something they didn’t intend to.</li>
<li>If we wish to expand on this functionality or do something different
with the output data, we must either overwrite our original script, or
copy the code across to a new scipt. If we choose to copy the script, it
would take a lot of effort to update all versions every time we wish to
adjust the core routine, and this is likely to introduce bugs.</li>
<li>The user must know where the script is stored on their system,
navigate to that directory, and call it from there. This makes it
challenging to string scripts together to make more complex
programs.</li>
</ul>
</div>
</div>
</div>
</div>
<p>It’s important to note that there’s nothing strictly <em>wrong</em>
with writing scripts in this way, and it’s often a good starting point
for a new project. However, as we develop our project further, we might
find it useful to bundle up the reusable bits of our code into a
<em>module</em> that we can <code>import</code> from other Python
programs, just as we <code>import</code>-ed Matplotlib in our own
script.</p>
</section><section id="what-is-a-module"><h2 class="section-heading">What is a ‘Module’?<a class="anchor" aria-label="anchor" href="#what-is-a-module"></a>
</h2>
<hr class="half-width">
<p>A <em>module</em> is simply any file containing Python statements,
so, technically, the script we defined above is already a module. The
name of a module is the same as the file name, only without the
<code>.py</code> extension. If we were to open a new Python interpretter
session and call the following:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> SIR_model_script</span></code></pre>
</div>
<p>then the script would run as if we’d run it from the command line.
However, the variables we defined in the script will be accessible
within the <em>namespace</em> <code>SIR_model_script</code>:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> SIR_model_script</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(<span class="bu">type</span>(SIR_model_script.S))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;class 'list'&gt;</code></pre>
</div>
<p>The current namespace includes all of the objects defined in our
interpretter session, plus all built-in Python functions and types. When
we <code>import</code> our script, we add the name of the script to the
current namespace, but not the variables defined within it; those are
defined within the <em>scope</em> of <code>SIR_model_script</code>, and
are only accessible using the dot operator. If we wanted to bring
everything within the script to the current namespace, but not the
module itself, we can instead call:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> SIR_model_script <span class="im">import</span> <span class="op">*</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(<span class="bu">type</span>(S))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;class 'list'&gt;</code></pre>
</div>
<p>Alternatively, if we only want a few objects brought into the current
namespace, we can use:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> SIR_model_script <span class="im">import</span> S, I, R</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(<span class="bu">type</span>(S), <span class="bu">type</span>(I), <span class="bu">type</span>(R))</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;class 'list'&gt; &lt;class 'list'&gt; &lt;class 'list'&gt;</code></pre>
</div>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="the-dangers-of-from-module-import" class="callout-inner">
<h3 class="callout-title">The dangers of
<code>from module import *</code><a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Using <code>from module import *</code> is considered harmful by many
developers, as objects can be unintentionally overwritten if there are
any name clashes between modules. It can also make it difficult for
people reading you code to tell which modules your functions and classes
have come from. In general, it’s better to be explicit about what you’re
<code>import</code>-ing.</p>
</div>
</div>
</div>
<p>It is also possible to assign an alias to a module name using the
<code>as</code> keyword:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> SIR_model_script <span class="im">as</span> script</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(<span class="bu">type</span>(script.S))</span></code></pre>
</div>
<p>Something to note about <code>import</code> is that it runs the code
found within the module only the first time it is imported, so if we
were to import our script multiple times, it would only create a plot
once.</p>
<p>While we’ve shown that our script is importable, so far it doesn’t
seem to provide many advantages over simply running it on the command
line. The next section will explain what features can make a module more
versatile and useful.</p>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>Let’s save the following code in the file
<code>my_module.py</code>:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">10</span></span></code></pre>
</div>
<p>Then we open an interpetter and call the following:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> my_module</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> my_module.x <span class="op">+=</span> <span class="dv">5</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> my_module</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(my_module.x)</span></code></pre>
</div>
<p>What is the result?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>The result is <code>15</code>, as the second import does not run the
code in <code>my_module.py</code>, and therefore
<code>my_module.x</code> is not reset back to <code>10</code>.</p>
</div>
</div>
</div>
</div>
</section><section id="making-a-reusable-module"><h2 class="section-heading">Making a Reusable Module<a class="anchor" aria-label="anchor" href="#making-a-reusable-module"></a>
</h2>
<hr class="half-width">
<p>A good Python module will tend to do the following:</p>
<ul>
<li>Define functions, classes and constants that the user might want to
use.</li>
<li>Not rely on global variables (those defined within the module but
not inside of functions/classes), except in a few scenarios where it
only makes sense for a single instance of the an object to exist.</li>
<li>Avoid performing runtime calculations at the <code>import</code>
stage.</li>
</ul>
<p>Most Python modules shouldn’t do anything if we try to run them from
the command line, and instead they should provide
<code>import</code>-able tools that can be used in the Python
interpretter, by other Python modules, or by dedicated scripts. We’ll
see later how to write a reusable Python module that doubles as a
runnable script.</p>
<p>Most scripts can be converted into reusable modules using the
following steps:</p>
<ul>
<li>Identify each major stage of our data processing. Examples may
include reading in data, running a model, processing results, creating
plots, etc.</li>
<li>For each stage, identify what data is an <em>input</em>, and what is
an <em>output</em>.</li>
<li>Bundle each processing stage into a function that takes the input
data as arguments and returns the output data.</li>
</ul>
<p>For example, the script <code>SIR_model_script</code> has two stages
that can be bundled into functions. The first stage runs the SIR model,
and it takes the following input parameters:</p>
<table class="table">
<colgroup>
<col width="12%">
<col width="8%">
<col width="78%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>pop_size</code></td>
<td><code>int</code></td>
<td>Total number of susceptible people at the start of an outbreak</td>
</tr>
<tr class="even">
<td><code>beta</code></td>
<td><code>float</code></td>
<td>Average no. of new infections per infected person per day</td>
</tr>
<tr class="odd">
<td><code>gamma</code></td>
<td><code>float</code></td>
<td>Inverse of the average number of days taken to recover</td>
</tr>
<tr class="even">
<td><code>days</code></td>
<td><code>int</code></td>
<td>Number of days to run the simulation for</td>
</tr>
<tr class="odd">
<td><code>I_0</code></td>
<td><code>int</code></td>
<td>Number of infected people at the start of the simulation</td>
</tr>
</tbody>
</table>
<p>The output data from this stage is:</p>
<table class="table">
<thead><tr class="header">
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>S</code></td>
<td><code>List[float]</code></td>
<td>Number of susceptible people each day</td>
</tr>
<tr class="even">
<td><code>I</code></td>
<td><code>List[float]</code></td>
<td>Number of infected people each day</td>
</tr>
<tr class="odd">
<td><code>R</code></td>
<td><code>List[float]</code></td>
<td>Number of recovered people each day</td>
</tr>
</tbody>
</table>
<p>We can therefore bundle this portion of the script into the function
<code>SIR_model</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SIR_model(pop_size, beta, gamma, days, I_0):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Solves a SIR model numerically using a simple integration scheme.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    pop_size: int</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Total number of susceptible people at the start of an outbreak.</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    beta: float</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Average number of new infections per infected person per day.</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma: float</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Inverse of the average number of days taken to recover.</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    days: int</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of days to run the simulation for.     </span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">    I_0: int</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of infected people at the start of the simulation.</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">    S: List[float]</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of susceptible people on each day.</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">    I: List[float]</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of infected people on each day.</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">    R: List[float]</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of recovered people on each day.</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialise data</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> [] <span class="co"># Number of susceptible people each day</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    I <span class="op">=</span> [] <span class="co"># Number of infected people each day</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> [] <span class="co"># Number of recovered people each day</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    S.append(pop_size <span class="op">-</span> I_0)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    I.append(I_0)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    R.append(<span class="dv">0</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solve model</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(days):</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get rate of change of S, I, and R</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        dS <span class="op">=</span> <span class="op">-</span> beta <span class="op">*</span> S[i] <span class="op">*</span> I[i] <span class="op">/</span> pop_size</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        dR <span class="op">=</span> gamma <span class="op">*</span> I[i]</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        dI <span class="op">=</span> <span class="op">-</span>(dS <span class="op">+</span> dR)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get values on next day</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        S.append(S[i] <span class="op">+</span> dS)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        I.append(I[i] <span class="op">+</span> dI)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        R.append(R[i] <span class="op">+</span> dR)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> S, I, R</span></code></pre>
</div>
<p>Note that we’ve provided a nice docstring, so that users of our
function can understand how to use it. The second stage of our script
takes the results of the SIR model as input data, and produces a plot.
We can therefore bundle the plotting parts of the script as follows:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: imports should go at the top of the file</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_SIR_model(S, I, R):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Plot the results of a SIR simulation.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    S: List[float]</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of susceptible people on each day.</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    I: List[float]</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of infected people on each day.</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">    R: List[float]</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of recovered people on each day.</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">    None</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(S)), S, label<span class="op">=</span><span class="st">"S"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(I)), I, label<span class="op">=</span><span class="st">"I"</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(R)), R, label<span class="op">=</span><span class="st">"R"</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Time /days"</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Population"</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code></pre>
</div>
<p>If we save the two code blocks above to a file called
<code>SIR_model.py</code>, we can then open up a Python interpreter and
run the following:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> SIR_model <span class="im">import</span> SIR_model, plot_SIR_model</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span><span class="dv">8000000</span>, beta<span class="op">=</span><span class="fl">0.5</span>, gamma<span class="op">=</span><span class="fl">0.1</span>, days<span class="op">=</span><span class="dv">150</span>, I_0<span class="op">=</span><span class="dv">10</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> plot_SIR_model(S, I, R)</span></code></pre>
</div>
<p>This should give us the same results as when we ran the script
earlier, and we can run the <code>SIR_model</code> function with
different inputs without needing to change the input parameters in the
file itself. The functions in our script are now therefore ‘reusable’,
and can be integrated in other workflows. The nice docstrings we added
can be viewed using the built-in <code>help()</code> function:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">help</span>(SIR_model)</span></code></pre>
</div>
<p>However, the script-like behaviour has been lost:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 SIR_model.py</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="co"># Nothing happens!</span></span></code></pre>
</div>
<p>In the next section, we’ll show how to maintain script-like
behaviour, and write reusable modules in the same file.</p>
</section><section id="maintaining-script-like-functionality"><h2 class="section-heading">Maintaining Script-Like Functionality<a class="anchor" aria-label="anchor" href="#maintaining-script-like-functionality"></a>
</h2>
<hr class="half-width">
<p>If we wish, we can also maintain the script-like behaviour using the
<code>if __name__ == "__main__".py</code> idiom at the bottom of the
file <code>SIR_model.py</code>:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: SIR_model.py</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add this after our function definitions</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span><span class="dv">8000000</span>, beta<span class="op">=</span><span class="fl">0.5</span>, gamma<span class="op">=</span><span class="fl">0.1</span>, days<span class="op">=</span><span class="dv">150</span>, I_0<span class="op">=</span><span class="dv">10</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R)</span></code></pre>
</div>
<p>With this is place, we can still run the module as if it were a
script:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 SIR_model.py</span></code></pre>
</div>
<p>However, this section will not run if we <code>import</code> the
file. Let’s break down how this works:</p>
<ul>
<li>Each Python module is automatically assigned a variable
<code>__name__</code>, and this is usually set to the name of the file
without the <code>.py</code> extension.</li>
</ul>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> SIR_model</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(SIR_model.<span class="va">__name__</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">"SIR_model"</span></span></code></pre>
</div>
<ul>
<li>The exception to the rule is when we run a Python module as a
script. In this case, the top-level file instead has its
<code>__name__</code> variable set to <code>"__main__"</code>.</li>
</ul>
<p>Therefore, the code written under
<code>if __name__ == "__main__"</code> will run if we use the module as
a script, but not if we <code>import</code> the file.</p>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge3"></a>
</h3>
<div class="callout-content">
<p>If we create the the file <code>name_test.py</code>, which contains
only the following line:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="va">__name__</span>)</span></code></pre>
</div>
<p>What happens if we run the following on the command line?</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 name_test.py</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>It prints <code>"__main__"</code></p>
</div>
</div>
</div>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<em> (continued)</em><a class="anchor" aria-label="anchor" href="#challenge4"></a>
</h3>
<div class="callout-content">
<p>What if instead we open an interpreter and import it?</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> name_test</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>It prints <code>"name_test"</code></p>
</div>
</div>
</div>
</div>
</section><section id="managing-pythonpath"><h2 class="section-heading">Managing PYTHONPATH<a class="anchor" aria-label="anchor" href="#managing-pythonpath"></a>
</h2>
<hr class="half-width">
<p>Our script is now <code>import</code>-able, so the
<code>SIR_model</code> function can be used from any other Python
script, module, or interpretter session. However, we still need to know
where the module is stored on our file system, which can make it
difficult to reuse the functions in a separate project. A simple
solution is to set the <code>PYTHONPATH</code> environment variable on
our system. On Linux machines, this can be achieved using:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> export PYTHONPATH=<span class="st">"</span><span class="va">${PYTHONPATH}</span><span class="st">:/path/to/my/module/directory"</span></span></code></pre>
</div>
<p>If you want this to be set every time you open a terminal, you can
add the line to the file <code>~/.bashrc</code>.</p>
<!-- TODO: include Windows explanation -->
<p>In a later chapter, we will show how to install our own modules using
the <code>pip</code> package manager, which gives us much more control
over how we integrate our modules into our Python environments (which
may be managed using tools such as <code>venv</code> or
<code>conda</code>), and also allows us to install packages from a
remote repository. We’ll also show how to upload our own packages to the
remote repository PyPI, and therefore allow others to download and
install our code from the command line!</p>
</section><section id="extra-better-automation-with-matplotlib"><h2 class="section-heading">Extra: Better Automation with Matplotlib<a class="anchor" aria-label="anchor" href="#extra-better-automation-with-matplotlib"></a>
</h2>
<hr class="half-width">
<p>Earlier, we converted the plotting section of our script into a
function that the user can call. There are two issues with the
implementation as it stands:</p>
<ul>
<li>The use of <code>plt.show()</code> interrupts the flow of the
program and requires the user to manually save the figure or discard it.
This makes it difficult to automate the production of figures.</li>
<li>As it calls <code>plt.plot()</code> without first creating a new
figure, it may interfere with our user’s Matplotlib code.</li>
</ul>
<p>We can improve the function with a few changes:</p>
<ul>
<li>Rather than using Matplotlib’s ‘implicit’ API (i.e. using
<code>plt.plot()</code>), which manages global Matplotlib objects, use
the ‘explicit’ API, sometimes called the ‘object-oriented’ API. This
requires handling <code>Figure</code> and <code>Axes</code> objects
directly.</li>
<li>Optionally take in an <code>Axes</code> object. This way, the user
can choose to set up their own <code>Figure</code> and
<code>Axes</code>, and our function can write to it.</li>
<li>Return the <code>Axes</code> object that we worked on, so that the
user can make further changes if they wish.</li>
<li>Only use <code>plt.show()</code> if the user requests it. Also
provide an option to save the figure.</li>
</ul>
<p>Here is an example of an improved function:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_SIR_model(S, I, R, ax<span class="op">=</span><span class="va">None</span>, save_to<span class="op">=</span><span class="va">None</span>, show<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Plot the results of a SIR simulation.</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">    S: List[float]</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of susceptible people on each day.</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co">    I: List[float]</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of infected people on each day.</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co">    R: List[float]</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of recovered people on each day.</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ax: Optional[plt.Axes], default None</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Axes object on which to create the plot.</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co">        A new Axes is created if this is None.</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co">    save_to: Optional[str], default None</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of the file to save the plot to.</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Does not save if None.</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="co">    show: bool, default False</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co">        If True, call plt.show() on completion.</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="co">    plt.Axes</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co">        The axes object the results have been plotted to.</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use plt.subplots to create Figure and Axes objects</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if one is not provided.</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create plot</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    ax.plot(<span class="bu">range</span>(<span class="bu">len</span>(S)), S, label<span class="op">=</span><span class="st">"S"</span>)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    ax.plot(<span class="bu">range</span>(<span class="bu">len</span>(I)), I, label<span class="op">=</span><span class="st">"I"</span>)</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    ax.plot(<span class="bu">range</span>(<span class="bu">len</span>(R)), R, label<span class="op">=</span><span class="st">"R"</span>)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Time /days"</span>)</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Population"</span>)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally save the figure</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_to <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>        fig.savefig(save_to)</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally show the figure</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show:</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code></pre>
</div>
<p>This gives our users much more control over how to create plots, and
it allows our function to be used as part of a larger automated pipeline
that runs without needing human input. There are many further ways we
could improve this function and allow our users to finely control what’s
plotted, such as by allowing the user to overwrite axis/line labels or
interact with legend placement, but we’ll move on from this topic for
now.</p>
</section><section id="extra-better-scripting-with-argparse"><h2 class="section-heading">Extra: Better scripting with <code>argparse</code><a class="anchor" aria-label="anchor" href="#extra-better-scripting-with-argparse"></a>
</h2>
<hr class="half-width">
<p>We showed earlier how to maintain script-like functionality in our
modules. We’ll update that code to include our updated plotting
function, so we’ll automatically save to a file if the user runs our
script:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: SIR_model.py</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span><span class="dv">8000000</span>, beta<span class="op">=</span><span class="fl">0.5</span>, gamma<span class="op">=</span><span class="fl">0.1</span>, days<span class="op">=</span><span class="dv">150</span>, I_0<span class="op">=</span><span class="dv">10</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R, save_to<span class="op">=</span><span class="st">"SIR_model.png"</span>)</span></code></pre>
</div>
<p>An issue with our example is that it still requires the user to
manually edit the file if they wish to change the input or outputs. This
problem can be solved by instead taking arguments from the command line.
A simple interface can be created using <code>sys.argv</code>, which is
a list of command line arguments in the form of strings:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: SIR_model.py</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: sys.argv[0] is the name of our program!</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    pop_size <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> <span class="bu">float</span>(sys.argv[<span class="dv">2</span>])</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> <span class="bu">float</span>(sys.argv[<span class="dv">3</span>])</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    days <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">4</span>])</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    I_0 <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">5</span>])</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> sys.argv[<span class="dv">6</span>]</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span>pop_size,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        beta<span class="op">=</span>beta,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        gamma<span class="op">=</span>gamma,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        days<span class="op">=</span>days,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        I_0<span class="op">=</span>I_0,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R, save_to<span class="op">=</span>output)</span></code></pre>
</div>
<p>However, this requires the user to provide every argument in order,
and doesn’t allow default arguments. We can achieve a better interface
using the built-in <code>argparse</code> library. The comments in the
code below explain how this works:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: SIR_model.py</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> argparse <span class="im">import</span> ArgumentParser</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an argument parser object. We can provide</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># some info about our program here.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> ArgumentParser(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        prog<span class="op">=</span><span class="st">"SIR_model"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Solves SIR model and creates a plot"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add each argument to the parser. We can specify</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the types of each argument. Optional arguments</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># should have single character names with a hypen,</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or longer names with a double dash.</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-p"</span>, <span class="st">"--pop_size"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10000000</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Total population size"</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-b"</span>, <span class="st">"--beta"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Average no. of new infections per infected person per day"</span>,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-g"</span>, <span class="st">"--gamma"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Inverse of average number of days taken to recover"</span>,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-d"</span>, <span class="st">"--days"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">150</span>,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Number of days to run the simulation"</span>,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-i"</span>, <span class="st">"--i0"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Number of infected people at the start of the simulation"</span>,</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-o"</span>, <span class="st">"--output"</span>, default<span class="op">=</span><span class="st">"SIR_model.png"</span>,</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Output file to save plot to"</span>,</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get each argument from the command line</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run our code</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span>args.pop_size,</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>        beta<span class="op">=</span>args.beta,</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>        gamma<span class="op">=</span>args.gamma,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>        days<span class="op">=</span>args.days,</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>        I_0<span class="op">=</span>args.i0,</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R, save_to<span class="op">=</span>args.output)</span></code></pre>
</div>
<p>We can now run our script using inputs from the command line:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 SIR_model.py <span class="at">--pop_size</span><span class="op">=</span>1000 <span class="at">--days</span><span class="op">=</span>10 <span class="at">-o</span> mymodel.png</span></code></pre>
</div>
<p>We defined each option with a default, so we don’t need to provide
all of them if we don’t want to. Each option has a long form with two
dashes (<code>--output</code>, <code>--beta</code>), and a short form
with one dash (<code>-o</code>, <code>-b</code>), which are
interchangeable (if we wish, we could provide only the short form or the
long form). Note that we can use either an equals <code>=</code> or a
space to separate the option name from its value.</p>
<p>If we had provided options without preceeding dashes, they would
become ‘positional’ arguments, and would be required. The order
positional arguments should be supplied is given by the order in which
they are added to the parser. For example, if we had added
<code>beta</code> and <code>gamma</code> as follows:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Average no. of new infections per infected person per day"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gamma"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Inverse of average number of days taken to recover"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre>
</div>
<p>We would need to supply these arguments in order when running our
code. Positional arguments are not specified by name on the command
line:</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 SIR_model.py 0.5 0.1 <span class="at">--pop_size</span><span class="op">=</span>1000 <span class="at">--days</span><span class="op">=</span>10 <span class="at">-o</span> mymodel.png</span></code></pre>
</div>
<p>If we forget how our script is supposed to be run,
<code>argparse</code> automatically provides a nice help message if we
run it with <code>-h</code> or <code>--help</code>:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 SIR_model.py <span class="at">--help</span></span></code></pre>
</div>
<pre class="result"><code>usage: SIR_model [-h] [-p POP_SIZE] [-b BETA] [-g GAMMA] [-d DAYS] [-i I0] [-o OUTPUT]

Solves SIR model and creates a plot

optional arguments:
  -h, --help            show this help message and exit
  -p POP_SIZE, --pop_size POP_SIZE
                        Total population size
  -b BETA, --beta BETA  Average no. of new infections per infected person per day
  -g GAMMA, --gamma GAMMA
                        Inverse of average number of days taken to recover
  -d DAYS, --days DAYS  Number of days to run the simulation
  -i I0, --i0 I0        Number of infected people at the start of the simulation
  -o OUTPUT, --output OUTPUT
                        Output file to save plot to</code></pre>
<p>There are many ways to control our command line interface in more
detail, such as constraining the possible user input choices, parsing
lists of inputs, and using ‘sub-parsers’ to split functionality across a
number of sub-commands, much like how <code>pip</code> handles its many
utilities:</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="at">--upgrade</span> mypkg myotherpkg</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip list <span class="at">--exclude</span> numpy</span></code></pre>
</div>
<p>Here, <code>install</code> and <code>list</code> are sub-commands,
which each handle a different set of their own args. We’ll show how to
achieve this in the next lesson, where we’ll expand our code from a
single module to a collection of modules known as a ‘package’.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Any Python file can be considered a ‘module’, and can be
<code>import</code>-ed. This just runs the code in the file, and makes
the names of any objects in the module accessible using
dot-notation.</li>
<li>If we bundle our Python scripts into a collection of functions, we
can reuse those functions in other modules or in the Python
interpretter.</li>
<li>After turning our scripts into reusable modules, we can maintain
script-like behaviour using the idiom
<code>if __name__ == "__main__"</code>.</li>
<li>
<code>argparse</code> can be used to create sophisticated command
line interfaces.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-02-packages"><p>Content from <a href="02-packages.html">From Modules to Packages</a></p>
<hr>
<p> Last updated on 2023-01-17 | 
        
        <a href="https://github.com/LiamPattinson/python-packaging/edit/main/episodes/02-packages.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is a ‘package’ in Python?</li>
<li>Why should we organise our code into packages?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain how to group multiple modules into a package.</li>
<li>Understand the purpose of an <code>__init__.py</code> file.</li>
<li>Understand how <code>__all__</code> works.</li>
<li>Understand the purpose of a <code>__main__.py</code> file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="packages"><h2 class="section-heading">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h2>
<hr class="half-width">
<p>In the previous lesson, we showed how to convert a simple Python
script into a reusable module by bundling up different parts of the
script into functions. However, as our project grows, we may find it
beneficial to spread the functionality of our project over multiple
files. Separating logically distinct units of code into their own files
will help others to understand how our project works, and it allows us
to control which features of our code are exposed to users at the top
level.</p>
<p>The primary tool for organising a project spread across multiple
files is the <em>package</em>. Packages are very similar to modules, and
they are defined by the directory structure we use to organise our
files.</p>
<p>As an example of how to use packages, we’ll return to the SIR model
introduced in the previous lesson. After some more time spent developing
this project, we may have added additional epidemiology models, such as
the SEIR model which introduces a new population category of those who
are Exposed to a pathogen, but not yet infectious themselves (this
models diseases such as COVID-19 fairly well). We could also add a SIS
model, which is similar to the SIR model, but Recovered individuals do
not gain immunity to the pathogen, and instead return to the Susceptible
population (this can apply to the common cold and some types of flu). A
good way to organise our code might be the following directory
structure:</p>
<!-- Package unicode &#128230; -->
<!-- Folder unicode &#128193; -->
<!-- File unicode &#128220; -->
<p><code> 📁 my_project<br> |<br> |____📦 epi_models<br>      |<br>
     |____📜 __init__.py<br>      |____📜 SIR.py<br>      |____📜
SEIR.py<br>      |____📜 SIS.py<br></code></p>
<p>Each model has its own file under the directory
<code>epi_models</code>, and we’ve also added a new file
<code>__init__.py</code>. The presence of an <code>__init__.py</code>
file marks the <code>epi_models</code> directory as a package, and the
contents of this file are run when the package or any modules within are
imported. For now, this file can be left empty – we’ll explain how to
use this file to set up and control our package in the next section.</p>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="namespace-packages" class="callout-inner">
<h3 class="callout-title">Namespace Packages<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>Since Python 3.3, if you omit <code>__init__.py</code>, you may find
that the following code snippets continue to work. This is because
directories without <code>__init__.py</code> act as <em>namespace
packages</em>, which can be used to build a package using multiple
‘portions’ spread across your system. The specification for namespace
packages can be found in <a href="https://peps.python.org/pep-0420/" class="external-link">PEP
420</a>.</p>
<p>Unless you’re intending to create a namespace package, it is good
practice to include <code>__init__.py</code>, even if you choose to
leave it empty, as this makes your intentions for the package
clearer.</p>
</div>
</div>
</div>
<p>To import our functions, we can now enter the <code>my_project</code>
directory and call the following in an interactive session:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> epi_models.SIR</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> S, I, R <span class="op">=</span> epi_models.SIR.SIR_model(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span><span class="dv">8000000</span>, beta<span class="op">=</span><span class="fl">0.5</span>, gamma<span class="op">=</span><span class="fl">0.1</span>, days<span class="op">=</span><span class="dv">150</span>, I_0<span class="op">=</span><span class="dv">10</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre>
</div>
<p>Having to type the package name and the module name every time can be
inconvenient, so it’s a good idea to use the alternative
<code>import</code> styles we discussed in the previous lesson:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="co"># Assign an alias to the import</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> epi_models.SEIR <span class="im">as</span> SEIR</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> S, E, I, R <span class="op">=</span> SEIR.SEIR_model(<span class="op">*</span>args)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="co"># Use 'from ... import ...' to get the function directly</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models.SEIR <span class="im">import</span> SEIR_model</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> S, E, I, R <span class="op">=</span> SEIR_model(<span class="op">*</span>args)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="co"># Import everything into the current namespace (not recommended!)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models.SIS <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> S, E, I, R <span class="op">=</span> SEIR_model(<span class="op">*</span>args)</span></code></pre>
</div>
<p>As our project develops, we may decide that we need a further level
of organisation. For example, if our modelling tools and our plotting
tools become sufficently complex, we may decide to move these into their
own directories. To do this, we can define <em>sub-packages</em> within
our top-level package:</p>
<p><code> 📁 my_project<br> |<br> |____📦 epi_models<br>      |<br>
     |____📜 __init__.py<br>      |<br>      |____📁 models<br>
     |    |<br>      |    |____📜 __init__.py<br>      |    |____📜
SIR.py<br>      |    |____📜 SEIR.py<br>      |    |____📜 SIS.py<br>
     |<br>      |____📁 plotting<br>           |<br>           |____📜
__init__.py<br>           |____📜 plot_SIR.py<br>           |____📜
plot_SEIR.py<br>           |____📜 plot_SIS.py<br></code></p>
<p>Note that each sub-directory, and hence sub-package, requires its own
<code>__init__.py</code>. With our project organised in this way, we can
now import each function using:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> epi_models.models.SIR <span class="im">as</span> SIR</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="co"># Alternatively, get a single function instead of a whole module:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models.plotting.plot_SEIR <span class="im">import</span> plot_SEIR_model</span></code></pre>
</div>
</section><section id="relative-imports"><h2 class="section-heading">Relative Imports<a class="anchor" aria-label="anchor" href="#relative-imports"></a>
</h2>
<hr class="half-width">
<p>One advantage of organising our code into packages and sub-packages
is that it allows us to import other modules using <em>relative
imports</em>. To show how these work, we’ll add an extra file
<code>utils.py</code> inside the <code>models</code> subpackage.</p>
<p><code> 📁 my_project<br> |<br> |____📦 epi_models<br>      |<br>
     |____📜 __init__.py<br>      |<br>      |____📁 models<br>
     |    |<br>      |    |____📜 __init__.py<br>      |    |____📜
SIR.py<br>      |    |____📜 SEIR.py<br>      |    |____📜 SIS.py<br>
     |    |____📜 utils.py<br>      |<br>      |____📁 plotting<br>
          |<br>           |____📜 __init__.py<br>           |____📜
plot_SIR.py<br>           |____📜 plot_SEIR.py<br>           |____📜
plot_SIS.py<br></code></p>
<p>This could contain utility functions that may be useful within
<code>SIR.py</code>, <code>SEIR.py</code>, and <code>SIS.py</code>. In
each of these files, we could import the function <code>some_func</code>
from <code>utils.py</code> using the following syntax:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .utils <span class="im">import</span> some_func</span></code></pre>
</div>
<p>The dot preceding the module name instructs Python to search inside
the current (sub-)package to find a module with a matching name.</p>
<p>We may also find it useful for our plotting tools to have access to
the modelling functions. In that case, we can add the following to
<code>plot_SIR.py</code>:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ..models.SIR <span class="im">import</span> SIR_model</span></code></pre>
</div>
<p>Here, the double dots indicate that we should look one package higher
than the current sub-package.</p>
<p>Note that relative imports only work within packages, so they should
be avoided in our plain scripts.</p>
</section><section id="the-__init__.py-file"><h2 class="section-heading">The <code>__init__.py</code> file<a class="anchor" aria-label="anchor" href="#the-__init__.py-file"></a>
</h2>
<hr class="half-width">
<p><code>__init__.py</code> files do not need to contain any code to
mark a directory as a Python package, but if we wish, we can use them to
control what is or isn’t visible at package-level scope, or to perform
any additional setup.</p>
<p>Consider the <code>__init__.py</code> file in the <code>models</code>
directory. Let’s add the following lines:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: epi_models/models/__init__.py</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .SIR <span class="im">import</span> SIR_model</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .SEIR <span class="im">import</span> SEIR_model</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .SIS <span class="im">import</span> SIS_model</span></code></pre>
</div>
<p>When <code>SIR_model</code>, <code>SEIR_model</code> and
<code>SIS_model</code> are brought into the local namespace in
<code>models/__init__.py</code>, they are brought into the namespace of
<code>epi_models.models</code> too:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models.models <span class="im">import</span> SIR_model</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="co"># Equivalent to:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models.models.SIR <span class="im">import</span> SIR_model</span></code></pre>
</div>
<p>If we wish to expose these functions to the user at the top level
package, we can also add the following to
<code>epi_models/__init__.py</code></p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: epi_models/__init__.py</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> SIR_model, SEIR_model, SIS_model</span></code></pre>
</div>
<p>Note that we can import these names directly from the
<code>models</code> sub-package instead of going to each of the modules
in turn. It is now much easier for users to access these functions:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models <span class="im">import</span> SIR_model</span></code></pre>
</div>
<p>When writing <code>__init__.py</code> files, it is important to
consider what we <em>don’t</em> import. Note that we did not import any
functions from <code>utils.py</code>, as these are only intended for use
within the <code>models</code> sub-package, and there’s no need to
expose these implementation details to the user. A well crafted
<code>__init__.py</code> allows us to define a <em>public API</em> while
keeping the internals private, which makes it much easier to develop our
project further without breaking things for the end-user. The following
sub-section introduces the <code>__all__</code> variable, which allows
us to more rigorously define a public API.</p>
<p>As the contents of <code>__init__.py</code> is run whenever the
package or any sub-packages/modules are imported, we can also use
<code>__init__.py</code> to perform any additional package-level setup.
For instance, it might be used to set up connection to a database used
throughout the package. In this way, <code>__init__.py</code> performs a
similar role for a package as an <code>__init__</code> function does for
a class.</p>
</section><section id="using-__all__-to-control-from-module-import"><h2 class="section-heading">Using <code>__all__</code> to control
<code>from module import *</code><a class="anchor" aria-label="anchor" href="#using-__all__-to-control-from-module-import"></a>
</h2>
<hr class="half-width">
<p><code>__all__</code> is an optional variable that we may set in our
modules and packages (i.e. in <code>__init__.py</code>). It should be a
list of strings matching the names of all objects – including functions,
classes, constants and variables – that we wish to be considered
‘public’ features that the user may wish to use.</p>
<p><code>__all__</code> also changes the behaviour of
<code>from module import *</code>. By default, this would import all
objects within the namespace of <code>module</code>, and bring them into
the current namespace. This may not be desirable, as this may bring
utility functions/classes/variables into the current scope, including
any objects we explicitly mark as private using a preceeding underscore,
and even anything we’ve imported. If we set <code>__all__</code>, only
those objects with names matching the strings contained within
<code>__all__</code> will be loaded. For example, if we wrote the
following:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: epi_models/__init__.py</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> SIR_model, SEIR_model, SIS_model</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [<span class="st">"SIR_model"</span>, <span class="st">"SEIR_model"</span>] <span class="co"># Note SIS_model is missing!</span></span></code></pre>
</div>
<p>Calling the following in an interactive session would work just
fine:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> epi_models <span class="im">import</span> <span class="op">*</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> SIR_model</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;function SIR_model at 0x7f0290dc9150&gt;</code></pre>
</div>
<p>However, the following would fail:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> SIS_model</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
NameError: name 'SIS_model' is not defined</code></pre>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="private-variables-in-python" class="callout-inner">
<h3 class="callout-title">‘Private’ variables in Python<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>It is common for Python programmers to mark objects as private by
prefixing their names with an underscore,
e.g. <code>_private_variable</code>, <code>_PrivateClass</code>, etc.
For an added layer of protection, variables set in class instances with
two underscores, i.e. <code>self.__x</code>, will have their names
mangled when viewed from outside the class, but they will still be
locatable and modifiable by a determined individual.</p>
<p>Python programmers will also sometimes use a <em>trailing</em>
underscore, and this is commonly used to avoid a name clash with a
built-in object, e.g.:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">lambda</span> <span class="op">=</span> <span class="dv">10</span> <span class="co"># Fails! Raises SyntaxError</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> lambda_ <span class="op">=</span> <span class="dv">10</span> <span class="co"># Works just fine</span></span></code></pre>
</div>
<p>A combination of the private naming convention, well chosen
<code>__all__</code> variables, and thorough documentation is more than
sufficient to specify a public API.</p>
</div>
</div>
</div>
</section><section id="script-like-packages-and-the-__main__.py-file"><h2 class="section-heading">Script-like Packages and the <code>__main__.py</code> file<a class="anchor" aria-label="anchor" href="#script-like-packages-and-the-__main__.py-file"></a>
</h2>
<hr class="half-width">
<p>In the previous lesson, we introduced the
<code>if __name__ == "__main__"</code> idiom, and discussed how to use
this to maintain script-like behaviour in our reusable modules. The good
news is that this is still possible when we upgrade our modules to
packages. For instance, let’s say that the file
<code>epi_models/plotting/plot_SIR</code> contains the following, which
excludes the enhancements added in the ‘extra’ section last lesson:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: plot_SIR.py</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_SIR_model(S, I, R):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Plot the results of a SIR simulation.</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    S: List[float]</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of susceptible people on each day.</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    I: List[float]</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of infected people on each day.</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">    R: List[float]</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of recovered people on each day.</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">    None</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(S)), S, label<span class="op">=</span><span class="st">"S"</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(I)), I, label<span class="op">=</span><span class="st">"I"</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="bu">len</span>(R)), R, label<span class="op">=</span><span class="st">"R"</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Time /days"</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Population"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span><span class="dv">8000000</span>, beta<span class="op">=</span><span class="fl">0.5</span>, gamma<span class="op">=</span><span class="fl">0.1</span>, days<span class="op">=</span><span class="dv">150</span>, I_0<span class="op">=</span><span class="dv">10</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R)</span></code></pre>
</div>
<p>If we jump into the directory <code>epi_models/plotting</code>, and
call the following, we get an error:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 plot_SIR.py</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Traceback (most recent call last):
  File "plot_SIR.py", line 2, in &lt;module&gt;
    from ..models.SIR import SIR_model
ImportError: attempted relative import with no known parent package</code></pre>
</div>
<p>When running a single file as if its a script, Python will not
consider it to be part of a wider package, and hence relative imports
will fail. To solve this, we should run our script from outside the
package using the <code>-m</code> flag:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> epi_models.plotting.plot_SIR</span></code></pre>
</div>
<p>Note that we use dots rather than slashes to separate the names of
each sub-package/module, and we don’t include <code>.py</code> at the
end.</p>
<p>We can also add script-like behaviour to packages by adding a
<code>__main__.py</code> file:</p>
<p><code> 📁 my_project<br> |<br> |____📦 epi_models<br>      |<br>
     |____📜 __init__.py<br>      |____📜 __main__.py<br>      |<br>
     |____📁 models<br>      |    |<br>      |    |____📜
__init__.py<br>      |    |____📜 SIR.py<br>      |    |____📜
SEIR.py<br>      |    |____📜 SIS.py<br>      |    |____📜 utils.py<br>
     |<br>      |____📁 plotting<br>           |<br>           |____📜
__init__.py<br>           |____📜 plot_SIR.py<br>           |____📜
plot_SEIR.py<br>           |____📜 plot_SIS.py<br></code></p>
<p>As the module name of this file is already <code>__main__</code>,
there’s no need to use the <code>if __name__ == "__main__"</code> idiom,
and we may write this file as if it were a simple script. If we wish to
run the scripting interface from <code>plot_SIR.py</code>, we can do so
by slightly refactoring <code>plot_SIR.py</code> such that the contents
of the <code>if __name__ == "__main__"</code> section are wrapped up in
a function <code>main()</code>:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: plot_SIR.py</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span><span class="dv">8000000</span>, beta<span class="op">=</span><span class="fl">0.5</span>, gamma<span class="op">=</span><span class="fl">0.1</span>, days<span class="op">=</span><span class="dv">150</span>, I_0<span class="op">=</span><span class="dv">10</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre>
</div>
<p>This can then be reused in <code>__main__.py</code>:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: __main__.py</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotting.plot_SIR <span class="im">import</span> main</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>main()</span></code></pre>
</div>
<p>If we add a different scripting interface for each model type, we can
use <code>sys.argv</code> to read the user’s model choice from the
command line:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: __main__.py</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotting.plot_SIR <span class="im">import</span> main <span class="im">as</span> SIR_main</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotting.plot_SEIR <span class="im">import</span> main <span class="im">as</span> SEIR_main</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotting.plot_SIS <span class="im">import</span> main <span class="im">as</span> SIS_main</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Read model type from the command line</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the chosen model</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> model <span class="op">==</span> <span class="st">"SIR"</span>:</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    SIR_main()</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> model <span class="op">==</span> <span class="st">"SEIR"</span>:</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    SEIR_main()</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> model <span class="op">==</span> <span class="st">"SIS"</span>:</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    SIS_main()</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"First cmd line arg should be 'SIR', 'SEIR', or 'SIS'"</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre>
</div>
<p>If you do intend to add scripting behaviour to your packages, it is
highly recommended to read the ‘extra’ sections in this lesson and the
previous one, as <code>argparse</code> allows you to build much more
sophisticated command line interfaces.</p>
</section><section id="extra-advanced-argparse-in-__main__.py"><h2 class="section-heading">Extra: Advanced <code>argparse</code> in
<code>__main__.py</code><a class="anchor" aria-label="anchor" href="#extra-advanced-argparse-in-__main__.py"></a>
</h2>
<hr class="half-width">
<p>Let’s return to <code>plot_SIR.py</code>, and apply the enhancements
discussed in the ‘extra’ sections last lesson:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> argparse <span class="im">import</span> ArgumentParser</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ..models.SIR <span class="im">import</span> SIR_model</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_SIR_model(S, I, R, ax<span class="op">=</span><span class="va">None</span>, save_to<span class="op">=</span><span class="va">None</span>, show<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Plot the results of a SIR simulation.</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    S: List[float]</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of susceptible people on each day.</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">    I: List[float]</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of infected people on each day.</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">    R: List[float]</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of recovered people on each day.</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ax: Optional[plt.Axes], default None</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Axes object on which to create the plot.</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co">        A new Axes is created if this is None.</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co">    save_to: Optional[str], default None</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of the file to save the plot to.</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Does not save if None.</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co">    show: bool, default False</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co">        If True, call plt.show() on completion.</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co">    plt.Axes</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co">        The axes object the results have been plotted to.</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use plt.subplots to create Figure and Axes objects</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if one is not provided.</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create plot</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    ax.plot(<span class="bu">range</span>(<span class="bu">len</span>(S)), S, label<span class="op">=</span><span class="st">"S"</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    ax.plot(<span class="bu">range</span>(<span class="bu">len</span>(I)), I, label<span class="op">=</span><span class="st">"I"</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    ax.plot(<span class="bu">range</span>(<span class="bu">len</span>(R)), R, label<span class="op">=</span><span class="st">"R"</span>)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Time /days"</span>)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Population"</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally save the figure</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_to <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>        fig.savefig(save_to)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally show the figure</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show:</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an argument parser object. We can provide</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># some info about our program here.</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> ArgumentParser(</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>        prog<span class="op">=</span><span class="st">"SIR_model"</span>,</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Solves SIR model and creates a plot"</span>,</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add each argument to the parser. We can specify</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the types of each argument. Optional arguments</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># should have single character names with a hypen,</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or longer names with a double dash.</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-p"</span>, <span class="st">"--pop_size"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10000000</span>,</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Total population size"</span>,</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-b"</span>, <span class="st">"--beta"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Average no. of new infections per infected person per day"</span>,</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-g"</span>, <span class="st">"--gamma"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Inverse of average number of days taken to recover"</span>,</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-d"</span>, <span class="st">"--days"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">150</span>,</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Number of days to run the simulation"</span>,</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-i"</span>, <span class="st">"--i0"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Number of infected people at the start of the simulation"</span>,</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-o"</span>, <span class="st">"--output"</span>, default<span class="op">=</span><span class="st">"SIR_model.png"</span>,</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Output file to save plot to"</span>,</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get each argument from the command line</span></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run our code</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span>args.pop_size,</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>        beta<span class="op">=</span>args.beta,</span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>        gamma<span class="op">=</span>args.gamma,</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>        days<span class="op">=</span>args.days,</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>        I_0<span class="op">=</span>args.i0,</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R, save_to<span class="op">=</span>args.output)</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre>
</div>
<p>This will work if we run
<code>python3 -m epi_models.plotting.plot_SIR</code>, but it won’t work
if we try to run it using <code>python3 -m epi_models SIR</code>, as we
need to read from the command line in <code>__main__.py</code> in order
to decide which model to run, but <code>plot_SIR.py</code> will also try
to read from the command line to determine its own setup. Inevitably,
each scripting interface will expect a different set of arguments. The
solution comes in the form of <code>subparsers</code>. We’ll show how
these work using the following simple example:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: subparsers.py</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> argparse <span class="im">import</span> ArgumentParser</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> ArgumentParser(description<span class="op">=</span><span class="st">"A test program"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># set up subparsers, make them required</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>subparsers <span class="op">=</span> parser.add_subparsers(required<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># add two subcommands: cmd1 and cmd2</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>parser1 <span class="op">=</span> subparsers.add_parser(<span class="st">"cmd1"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>parser2 <span class="op">=</span> subparsers.add_parser(<span class="st">"cmd2"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># add some args to each</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>parser1.add_argument(<span class="st">"foo"</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>parser1.add_argument(<span class="st">"bar"</span>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>parser2.add_argument(<span class="st">"baz"</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># parse args and print what we get</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(args)</span></code></pre>
</div>
<p>If we try running this with no arguments, it breaks! If we check how
it should work using <code>--help</code>:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 subparsers.py <span class="at">--help</span></span></code></pre>
</div>
<pre class="result"><code>usage: subparsers.py [-h] {cmd1,cmd2} ...

A test program

positional arguments:
  {cmd1,cmd2}

optional arguments:
  -h, --help   show this help message and exit</code></pre>
<p>We therefore need to supply either <code>cmd1</code> or
<code>cmd2</code> as the first argument. We can then get further info on
each subcommand:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 subparsers.py cmd1 <span class="at">--help</span></span></code></pre>
</div>
<pre class="result"><code>usage: subparsers.py cmd1 [-h] foo bar

positional arguments:
  foo
  bar

optional arguments:
  -h, --help  show this help message and exit</code></pre>
<p>So what if we provide these arguments?</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 subparsers.py cmd1 1 2</span></code></pre>
</div>
<pre class="result"><code><span><span class="fu">Namespace</span><span class="op">(</span>bar<span class="op">=</span><span class="st">'2'</span>, foo<span class="op">=</span><span class="st">'1'</span><span class="op">)</span></span></code></pre>
<p>We see that <code>foo</code> and <code>bar</code> are defined within
<code>args</code>, but not <code>baz</code>. Similarly:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 subparsers.py cmd2 3</span></code></pre>
</div>
<pre class="result"><code><span><span class="fu">Namespace</span><span class="op">(</span>baz<span class="op">=</span><span class="st">'3'</span><span class="op">)</span></span></code></pre>
<p>We can therefore use subparsers to set up multiple independent
command line interfaces using the same root command. If we wished, we
could even create further subparsers from our subparsers, leading to a
nested command line interface! Something to note is that information
about which command was chosen is <em>not</em> contained within args;
we’ll show a workaround for this later using
<code>set_defaults()</code>.</p>
<p>Let’s apply subparsers to our <code>epi_models</code> package. First,
our <code>main()</code> function should be split into a function that
assigns arguments to an <code>ArgumentParser</code>, and a function that
runs the code using <code>args</code>:</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: plot_SIR.py</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _add_arguments(parser):</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-p"</span>, <span class="st">"--pop_size"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10000000</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Total population size"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-b"</span>, <span class="st">"--beta"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Average no. of new infections per infected person per day"</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-g"</span>, <span class="st">"--gamma"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>, default<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Inverse of average number of days taken to recover"</span>,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-d"</span>, <span class="st">"--days"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">150</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Number of days to run the simulation"</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-i"</span>, <span class="st">"--i0"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Number of infected people at the start of the simulation"</span>,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-o"</span>, <span class="st">"--output"</span>, default<span class="op">=</span><span class="st">"SIR_model.png"</span>,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Output file to save plot to"</span>,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main(args):</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run our code</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    S, I, R <span class="op">=</span> SIR_model(</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>        pop_size<span class="op">=</span>args.pop_size,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>        beta<span class="op">=</span>args.beta,</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>        gamma<span class="op">=</span>args.gamma,</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>        days<span class="op">=</span>args.days,</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>        I_0<span class="op">=</span>args.i0,</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    plot_SIR_model(S, I, R, save_to<span class="op">=</span>args.output)</span></code></pre>
</div>
<p>The <code>if __name__ == "__main__"</code> section should be tasked
with creating an <code>ArgumentParser</code> and coordinating
everything:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: plot_SIR.py</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> ArgumentParser(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        prog<span class="op">=</span><span class="st">"SIR_model"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Solves SIR model and creates a plot"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    _add_arguments(parser)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
<p>As the <code>_add_arguments(parser)</code> function doesn’t care
whether it’s supplied with a parser or a subparser, this will work just
fine if we run this file directly using
<code>python3 -m epi_models.plotting.plot_SIR</code>.</p>
<p>A similar refactor should be applied for every other model. There is
no need for each model to require the same command line arguments, but
they should each have a function equivalent to
<code>_add_arguments(parser)</code> and <code>main(args)</code>.</p>
<p>We can then switch between each model in <code>__main__.py</code>
using subparsers. The file below shows how to achieve a rich command
line interface for <code>epi_models</code>:</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: __main__.py</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> argparse <span class="im">import</span> ArgumentParser</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Import each _add_arguments and main, giving each an alias</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .plotting.plot_SIR <span class="im">import</span> main <span class="im">as</span> SIR_main</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .plotting.plot_SEIR <span class="im">import</span> main <span class="im">as</span> SEIR_main</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .plotting.plot_SIS <span class="im">import</span> main <span class="im">as</span> SIS_main</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .plotting.plot_SIR <span class="im">import</span> _add_arguments <span class="im">as</span> add_SIR_arguments</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .plotting.plot_SIR <span class="im">import</span> _add_arguments <span class="im">as</span> add_SEIR_arguments</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .plotting.plot_SIR <span class="im">import</span> _add_arguments <span class="im">as</span> add_SIS_arguments</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create top-level ArgumentParser</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> ArgumentParser(</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    prog<span class="op">=</span><span class="st">"epi_models"</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Tool for solving epidemiology models"</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up subparsers, adding a new one for each model</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>subparsers <span class="op">=</span> parser.add_subparsers(required<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>SIR_parser <span class="op">=</span> subparsers.add_parser(<span class="st">"SIR"</span>)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>SEIR_parser <span class="op">=</span> subparsers.add_parser(<span class="st">"SEIR"</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>SIS_parser <span class="op">=</span> subparsers.add_parser(<span class="st">"SIS"</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup each subparser using each model's _add_arguments</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>add_SIR_arguments(SIR_parser)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>add_SEIR_arguments(SEIR_parser)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>add_SIS_arguments(SIS_parser)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure each parser knows which function to call.</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="co"># set_defaults can be used to set a new arg which</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="co"># isn't set on the command line.</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>SIR_parser.set_defaults(main<span class="op">=</span>SIR_main)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>SEIR_parser.set_defaults(main<span class="op">=</span>SEIR_main)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>SIS_parser.set_defaults(main<span class="op">=</span>SIS_main)</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract command line arguments and run</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>args.main(args)</span></code></pre>
</div>
<p>Here, we used <code>set_defaults()</code> to assign each model’s
<code>main()</code> function to the variable <code>main</code> within
<code>args</code>. This will be set depending on which subcommand the
user provides. Each model’s <code>_add_arguments</code> can be used as a
‘black box’, and each can be developed independently of the others.</p>
<p>Following this, we can use <code>epi_models</code> to run several
different models, each with their own command line interface!</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> epi_models SIR <span class="at">--pop_size</span><span class="op">=</span>300 <span class="at">--output</span><span class="op">=</span><span class="st">"SIR.png"</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> epi_models SEIR <span class="at">--alpha</span><span class="op">=</span>1</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Packages can be used to better organise our code as it becomes more
complex</li>
<li>Packages are defined by a directory structure and the presence of
<code>__init__.py</code>
</li>
<li>By controlling what is or isn’t imported in
<code>__init__.py</code>, we can define a public API for our
project.</li>
<li>A package can be run as a script using the <code>-m</code> flag,
provided it contains a file <code>__main__.py</code>.</li>
<li>Through clever use of <code>argparse</code>, we can provide a rich
scripting interface to a whole package.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-03-building-and-installing"><p>Content from <a href="03-building-and-installing.html">Building and Installing Packages using setuptools</a></p>
<hr>
<p> Last updated on 2023-01-17 | 
        
        <a href="https://github.com/LiamPattinson/python-packaging/edit/main/episodes/03-building-and-installing.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we manage our Python environment?</li>
<li>How can we install our own packages?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use <code>venv</code> to manage Python environments</li>
<li>Understand what happens when we install a package</li>
<li>Use <code>setuptools</code> to install packages to our local
environment</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="introduction"><h2 class="section-heading">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>In the first lesson, we showed how to use the <code>PYTHONPATH</code>
environment variable to enable us to import our modules and packages
from anywhere on our system. There are a few disadvantages to this
method:</p>
<ul>
<li>If we have two different versions of a package on our system at
once, it can be tedious to manually update <code>PYTHONPATH</code>
whenever we want to switch between them.</li>
<li>If we have multiple Python environments on our system (e.g. using
<code>venv</code> or <code>conda</code>), setting
<code>PYTHONPATH</code> will affect all of them.</li>
<li>If we share our software with others and require them to update
their own <code>PYTHONPATH</code>, they will need to install any
requirements for our package separately, which can be error prone.</li>
</ul>
<p>It would be preferable if we could install our package using
<code>pip</code>, the same way that we would normally install external
Python packages. However, if we try the following:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd my_project</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install .</span></code></pre>
</div>
<p>We get the following error:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>ERROR: Directory '.' is not installable. Neither 'setup.py' nor 'pyproject.toml' found.</code></pre>
</div>
<p>In order to make our project installable, we need to add the either
the file <code>pyproject.toml</code> or <code>setup.py</code> to our
project. For modern Python projects, it is recommended to write only
<code>pyproject.toml</code>. This was introduced by <a href="https://peps.python.org/pep-0517/" class="external-link">PEP 517</a>, <a href="https://peps.python.org/pep-0518/" class="external-link">PEP 518</a> and <a href="https://peps.python.org/pep-0621/" class="external-link">PEP 621</a> as a standard way
to define a Python project, and all tools that build, install, and
publish Python packages are expected to use it.</p>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="what-is-setup.py" class="callout-inner">
<h3 class="callout-title">What is <code>setup.py</code>?<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p><code>setup.py</code> serves a similar role to
<code>pyproject.toml</code>, but it is no longer recommended for use.
The lesson on the <a href="04-history-of-packaging.html">history of
build tools</a> explains how it works and why the community has moved
away from it.</p>
</div>
</div>
</div>
<p>By making our project <code>pip</code>-installable, we’ll also make
it very easy to publish our packages on public repositories – this will
be covered in our <a href="./05-publishing.html">lesson on package
publishing</a>. After publishing our work, our users will be able to
download and install our package using <code>pip</code> from any machine
of their chocie!</p>
<p>To begin, we’ll introduce the concept of a ‘Python environment’, and
how these can help us manage our workflows.</p>
</section><section id="managing-python-environments"><h2 class="section-heading">Managing Python Environments<a class="anchor" aria-label="anchor" href="#managing-python-environments"></a>
</h2>
<hr class="half-width">
<p>When working with Python, it can sometimes be beneficial to install
packages to an isolated environment instead of installing them globally.
Usually, this is done to manage competing dependencies:</p>
<ul>
<li>Project B might depend upon Project A, but may have been written to
use version 1.0.</li>
<li>Project C might also depend upon Project A, but may instead only
work with version 2.0.</li>
<li>If we install Project A globally and choose version 2.0, then
Project B will not work. Similarly, if we choose version 1.0, Project C
will not work.</li>
</ul>
<p>A good way to handle these sorts of conflicts is to instead use
<em>virtual environments</em> for each project. A number of tools have
been developed to manage virtual environments, such as
<code>venv</code>, which is a standard built-in Python tool, and
<code>conda</code>, which is a powerful third-party tool. We’ll focus on
<code>venv</code> here, but both tools work similarly.</p>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Contrary to what some believe, you can <code>pip install</code>
packages into a <code>conda</code> virtual environment.</p>
</div>
</div>
</div>
<p>If we’re using Linux, we can find which Python environment we’re
using by calling:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> which python3</span></code></pre>
</div>
<p>If we’re using the default system environment, the result is
something like the following:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/usr/bin/python3</code></pre>
</div>
<p>To create a new virtual environment using <code>venv</code>, we can
call:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> venv /path/to/my/env</span></code></pre>
</div>
<p>This will create a new directory at the location
<code>/path/to/my/env</code>. Note that this can be a relative path, so
just calling <code>python3 -m venv myenv</code> will create the virtual
environment in the directory <code>./myenv</code>. We can then
‘activate’ the virtual environment using:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> source /path/to/my/env/bin/activate</span></code></pre>
</div>
<p>Checking which Python we’re running should now give a different
result:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> which python3</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/path/to/my/env/bin/python3</code></pre>
</div>
<p>If we now install a new package, it will be installed within our new
virtual environment instead of being installed to the system libraries.
For example:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install numpy</span></code></pre>
</div>
<p>We should now find NumPy installed at the following location (note
that the Python version may not match yours):</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls /path/to/my/env/lib/python3.8/site-packages/numpy</span></code></pre>
</div>
<p>If we no longer wish to use this virtual environment, we can return
to the system environment by calling:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> deactivate</span></code></pre>
</div>
<p>Virtual environments are very useful when we’re testing out code, as
they allow us to create a fresh Python environment without any of the
installed packages we normally use in our own work. This will be
important later when we add dependencies to our own package, as this
allows us to test whether our users will be able to install and run our
code properly.</p>
</section><section id="an-overview-of-toml-files"><h2 class="section-heading">An Overview of TOML files<a class="anchor" aria-label="anchor" href="#an-overview-of-toml-files"></a>
</h2>
<hr class="half-width">
<p><code>pyproject.toml</code> is a TOML file, which stands for ‘Tom’s
Obvious Minimal Langauge’ (named for its developer, Thomas
Preston-Werner, who cofounded GitHub). There are many configuration file
formats in common usage, such as YAML, JSON, and INI, but the Python
community chose TOML as it provides some benefits over the
competition:</p>
<ul>
<li>Designed to be human writable and human readable.</li>
<li>Can map unambiguously to a hash table (i.e. a <code>dict</code> in
Python).</li>
<li>It has a formal specification, so has an unambiguous set of
rules.</li>
</ul>
<p>A TOML file contains a series of <code>key = value</code> pairs,
which may be grouped into sections using a header enclosed in square
brackets (i.e. <code>[section name]</code>). The values are typed,
unlike some other formats where all values are strings. The available
types are strings, integers, floats, booleans, and dates. It is possible
to store lists of values in arrays, or store a series of key-value pairs
in tables. For example:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: mytoml.toml</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int_val</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="dt">float_val</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="dt">string_val</span> <span class="op">=</span> <span class="st">"hello world"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">bool_val</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="dt">date_val</span> <span class="op">=</span> <span class="bn">2023-01-01T08:00:00</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span> <span class="op">=</span> <span class="op">[</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">]</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="dt">inline_table</span> <span class="op">=</span> <span class="op">{</span><span class="dt">key</span><span class="op"> =</span> <span class="st">"value"</span><span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Section headings allow us to define tables over</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># multiple lines</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">header_table</span><span class="kw">]</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"John"</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="dt">dob</span> <span class="op">=</span> <span class="bn">2002-03-05</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># We can define subtables using dot notation</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">header_table</span><span class="kw">.</span><span class="dt">subtable</span><span class="kw">]</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="dt">foo</span> <span class="op">=</span> <span class="st">"bar"</span></span></code></pre>
</div>
<p>We can read this using the <code>toml</code> libray in Python:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install toml</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> toml</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"mytoml.toml"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>...     data <span class="op">=</span> toml.load(f)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(data)</span></code></pre>
</div>
<p>The result is a dictionary object, with TOML types converted to their
corresponding Python types:</p>
<pre class="result"><code>{
    'int_val': 5,
    'float_val': 0.5,
    'string_val': 'hello world',
    'bool_val': True,
    'date_val': datetime.datetime(2023, 1, 1, 8, 0),
    'array': [1, 2, 3],
    'inline_table': {'key': 'value'},
    'header_table': {
        'name': 'John', 
        'dob': datetime.date(2002, 3, 5),
        'subtable': {
            'foo': 'bar'
        }
    }
}</code></pre>
<div id="callout2" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout2"></a>
</h3>
<div class="callout-content">
<p>Since Python 3.11, <code>tomllib</code> is part of Python’s standard
library. It works the same as above, but you’ll need to import
<code>tomllib</code> instead of <code>toml</code>.</p>
</div>
</div>
</div>
</section><section id="installing-our-package-with-pyproject.toml"><h2 class="section-heading">Installing our package with <code>pyproject.toml</code><a class="anchor" aria-label="anchor" href="#installing-our-package-with-pyproject.toml"></a>
</h2>
<hr class="half-width">
<p>First, we will show how to write a relatively minimal
<code>pyproject.toml</code> file so that we can install our projects
using <code>pip</code>. We will then cover some additional tricks that
can be achieved with this file:</p>
<ul>
<li>Use alternative directory structures</li>
<li>Include any data files needed by our code</li>
<li>Generate an executable so that our scripts can be run directly from
the command line</li>
<li>Configure our development tools.</li>
</ul>
<p>To make our package <code>pip</code>-installable, we should add the
file <code>pyproject.toml</code> to the directory that contains our
package. It is common for this directory to have the same name as the
package itself:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 pyproject.toml<br> |____📦
epi_models<br>      |<br>      |____📜 __init__.py<br>      |____📜
__main__.py<br>      |<br>      |____📁 models<br>      |    |<br>
     |    |____📜 __init__.py<br>      |    |____📜 SIR.py<br>
     |    |____📜 SEIR.py<br>      |    |____📜 SIS.py<br>
     |    |____📜 utils.py<br>      |<br>      |____📁 plotting<br>
          |<br>           |____📜 __init__.py<br>           |____📜
plot_SIR.py<br>           |____📜 plot_SEIR.py<br>           |____📜
plot_SIS.py<br></code></p>
<p>The first section in our <code>pyproject.toml</code> file should
specify which build system we wish to use, and additionally specify any
version requirements for packages used to build our code. This is
necessary to avoid a circular dependecy problem that occurred with
earlier Python build systems, in which the user had to run an install
program to determine the project’s dependencies, but needed to already
have the correct build tool installed to run the install program – see
the <a href="04-history-of-packaging.html">lesson on historical build
tools</a> for more detail. We will choose to use
<code>setuptools</code>, which requires the following:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">build-system</span><span class="kw">]</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="dt">requires</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"setuptools &gt;= 65"</span><span class="op">,</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wheel &gt;= 0.38,</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="dt">build-backend</span> <span class="op">=</span> <span class="st">"setuptools.build_meta"</span></span></code></pre>
</div>
<ul>
<li>
<code>requires</code> is set to a list of strings, each of which
names a dependency of the build system and (optionally) its minimum
version. This uses the same version syntax as <code>pip</code>.</li>
<li>
<code>build-backend</code> is set to a sub-module of
<code>setuptools</code> which implements the <a href="https://peps.python.org/pep-0517/" class="external-link">PEP 517</a> build
interface.</li>
</ul>
<p>With our build system determined, we can add some metadata that
defines our project. At a minimum, we should specify the name of the
package, its version, and our dependencies:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">build-system</span><span class="kw">]</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="dt">requires</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"setuptools &gt;= 65"</span><span class="op">,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wheel &gt;= 0.38,</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="dt">build-backend</span> <span class="op">=</span> <span class="st">"setuptools.build_meta"</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"epi_models"</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"matplotlib"</span><span class="op">,</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>That’s all we need! We’ll discuss versioning in our <a href="05-publishing.html">lesson on publishing</a>. With this done, we
can install our package using:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install .</span></code></pre>
</div>
<p>This will automatically download and install our dependencies, and
our package will be importable regardless of which directory we’re
in.</p>
<p>The installed package can be found in the directory
<code>/path/to/my/env/lib/python3.8/site-packages/epi_models</code>
along with a new directory, <code>epi_models-0.1.0.dist-info</code>,
which simply contains metadata describing our project. If we look inside
our installed package, we’ll see that our files have been copied, and
there is also a <code>__pycache__</code> directory:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls /path/to/my/env/lib/python3.8/site-packages/epi_models</span></code></pre>
</div>
<pre class="results"><code>__init__.py  __main__.py  models  plotting  __pycache__</code></pre>
<p>The <code>__pycache__</code> directory contains Python bytecode,
which is a lower-level version of Python that is understood by the
Python Virtual Machine (PVM). All of our Python code is converted to
bytecode when it is run or imported, and by pre-compiling our package it
can be imported much faster. If we look into the directories
<code>models</code> and <code>plotting</code>, we’ll see those have been
compiled to bytecode too.</p>
<p>If we wish to uninstall, we may call:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip uninstall epi_models</span></code></pre>
</div>
<p>We can also create an ‘editable install’, in which any changes we
make to our code are instantly recognised by any codes importing it –
this mode can be very useful when developing our code, especially when
working on documentation or tests.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install <span class="at">-e</span> .</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="co"># Or...</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install <span class="at">--editable</span> .</span></code></pre>
</div>
<div id="callout3" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout3"></a>
</h3>
<div class="callout-content">
<p>The ability to create editable installs from a
<code>pyproject.toml</code>-only build was standardised in <a href="https://peps.python.org/pep-0660/" class="external-link">PEP 660</a>, and only recently
implemented in <code>pip</code>. You may need to upgrade to use this
feature:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install <span class="at">--upgrade</span> pip</span></code></pre>
</div>
</div>
</div>
</div>
<p>There are many other options we can add to our
<code>pyproject.toml</code> to better describe our project. <a href="https://peps.python.org/pep-0621/" class="external-link">PEP 621</a> defines a minimum
list of possible metadata that all build tools should support, so we’ll
stick to that list. Each build tool will also define synonyms for some
metadata entries, and additional tool-specific metadata. Some of the
recommended core metadata keys are described below:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># name: String, REQUIRED</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"my_project"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># version: String, REQUIRED</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Should follow PEP 440 rules</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Can be provided dynamically, see the lesson on publishing</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"1.2.3"</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># description: String</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># A simple summary of the project</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="dt">description</span> <span class="op">=</span> <span class="st">"My wonderful Python package"</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co"># readme: String</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Full description of the project.</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Should be the path to your README file, relative to pyproject.toml</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="dt">readme</span> <span class="op">=</span> <span class="st">"README.md"</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co"># requires-python: String</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The Python version required by the project</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="dt">requires-python</span> <span class="op">=</span> <span class="st">"&gt;=3.8"</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># license: Table</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co"># The license of your project.</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Can be provided as a file or a text description.</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Discussed in the lesson on publishing</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="dt">license</span> <span class="op">=</span> <span class="op">{</span><span class="dt">file</span><span class="op"> =</span> <span class="st">"LICENSE.md"</span><span class="op">}</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co"># or...</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="dt">license</span> <span class="op">=</span> <span class="op">{</span><span class="dt">text</span><span class="op"> =</span> <span class="st">"BDS 3-Clause License"</span><span class="op">}</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co"># authors: Array of Tables</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Can also be called 'maintainers'.</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Each entry can have a name and/or an email</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="dt">authors</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="dt">name</span><span class="op"> =</span> <span class="st">"My Name"</span><span class="op">, </span><span class="dt">email</span><span class="op"> =</span> <span class="st">"my.email@email.net"</span><span class="op">},</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="dt">name</span><span class="op"> =</span> <span class="st">"My Friend"</span><span class="op">, </span><span class="dt">email</span><span class="op"> =</span> <span class="st">"their.email@email.net"</span><span class="op">},</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co"># urls: Table</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Should describe where to find useful info for your project</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="dt">urls</span> <span class="op">=</span> <span class="op">{</span><span class="dt">source</span><span class="op"> =</span> <span class="st">"github.com/MyProfile/my_project"</span><span class="op">, </span><span class="dt">documentation</span><span class="op"> =</span> <span class="st">"my_project.readthedocs.io/en/latest"</span><span class="op">}</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="co"># dependencies: Array of Strings</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="co"># A list of requirements for our package</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"numpy &gt;= 1.20"</span><span class="op">,</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pyyaml"</span><span class="op">,</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>Note that some of the longer tables in our TOML file can be written
using non-inline tables if it improved readability:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">.</span><span class="dt">urls</span><span class="kw">]</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Source</span> <span class="op">=</span> <span class="st">"github.com/MyProfile/my_project"</span><span class="er">,</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Documentation</span> <span class="op">=</span> <span class="st">"my_project.readthedocs.io/en/latest"</span><span class="er">,</span></span></code></pre>
</div>
</section><section id="alternative-directory-structures"><h2 class="section-heading">Alternative Directory Structures<a class="anchor" aria-label="anchor" href="#alternative-directory-structures"></a>
</h2>
<hr class="half-width">
<p><code>setuptools</code> provides some additional tools to help us
install our package if they use a different layout to the ‘flat’ layout
we covered so far. A popular alternative layout is the
<code>src</code>-layout:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 pyproject.toml<br> |____📁
src<br>      |<br>      |____📦 epi_models<br>           |<br>
          |____📜 __init__.py<br>           |____📜 __main__.py<br>
          |____📁 models<br>           |____📁 plotting<br></code></p>
<p>The main benefit of this choice is that <code>setuptools</code> won’t
accidentally bundle any utility modules stored in the top-level
directory with our package. It can also be neater when one project
contains multiple packages. Note that directories and files with special
names are excluded by default regardless of which layout we choose, such
as <code>test/</code>, <code>docs/</code>, and
<code>setup.py</code>.</p>
<p>We can also disable automatic package discovery and explicitly list
the packages we wish to install:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">setuptools</span><span class="kw">]</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pacakges</span> <span class="op">=</span> <span class="op">[</span><span class="st">"my_package"</span><span class="op">,</span> <span class="st">"my_other_package"</span><span class="op">]</span></span></code></pre>
</div>
<p>Note that this is not part of the <a href="https://peps.python.org/pep-0621/" class="external-link">PEP 621</a> standard, and
instead is a method specific to <code>setuptools</code>. Finally, we may
set up custom package discovery:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">setuptools</span><span class="kw">.</span><span class="dt">packages</span><span class="kw">.</span><span class="dt">find</span><span class="kw">]</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">where</span> <span class="op">=</span> <span class="op">[</span><span class="st">"my_directory"</span><span class="op">]</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="dt">include</span> <span class="op">=</span> <span class="op">[</span><span class="st">"my_package"</span><span class="op">,</span> <span class="st">"my_other_package"</span><span class="op">]</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="dt">exclude</span> <span class="op">=</span> <span class="op">[</span><span class="st">"my_package.tests*"</span><span class="op">]</span></span></code></pre>
</div>
<p>However, for ease of use, it is recommended to stick to either the
flat layout or the <code>src</code> layout.</p>
</section><section id="package-data"><h2 class="section-heading">Package Data<a class="anchor" aria-label="anchor" href="#package-data"></a>
</h2>
<hr class="half-width">
<p>Sometimes our code requires some non-<code>.py</code> files in order
to function properly, but these would not be picked up by automatic
package discovery. For example, the project may store default input data
in <code>.json</code> files. These could be included with your package
by adding the following to <code>pyproject.toml</code>:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">setuptools</span><span class="kw">.</span><span class="dt">package-data</span><span class="kw">]</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="dt">epi_models</span> <span class="op">=</span> <span class="op">[</span><span class="st">"*.json"</span><span class="op">]</span></span></code></pre>
</div>
<p>Note that this would grab only <code>.json</code> files in the
top-level directory of our project. To include data files from all
packages and sub-packages, we should instead write:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">setuptools</span><span class="kw">.</span><span class="dt">package-data</span><span class="kw">]</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="dt">"*"</span> <span class="op">=</span> <span class="op">[</span><span class="st">"*.json"</span><span class="op">]</span></span></code></pre>
</div>
</section><section id="installing-scripts"><h2 class="section-heading">Installing Scripts<a class="anchor" aria-label="anchor" href="#installing-scripts"></a>
</h2>
<hr class="half-width">
<p>If our package contains any scripts and/or a <code>__main__.py</code>
file, we can run those from anywhere on our system after
installation:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> epi_models</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> epi_models.plotting.plot_SIR</span></code></pre>
</div>
<p>With a little extra work, we can also install a simplified interface
that doesn’t require <code>python3 -m</code> in front. This is how tools
like <code>pip</code> can be invoked using two possible methods:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip  <span class="co"># Invoke with python</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip             <span class="co"># Invoke via console-scripts entrypoint</span></span></code></pre>
</div>
<p>This can be achieved by adding a table <code>scripts</code> under the
<code>[project]</code> header:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="dt">scripts</span> <span class="op">=</span> <span class="op">{</span><span class="dt">epi_models</span><span class="op"> =</span> <span class="st">"epi_models.__main__:main"</span><span class="op">}</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative form:</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">.</span><span class="dt">scripts</span><span class="kw">]</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="dt">epi_models</span> <span class="op">=</span> <span class="st">"epi_models.__main__:main"</span></span></code></pre>
</div>
<p>This syntax means that we should create a console script
<code>epi_models</code>, and that running it should call the function
<code>main()</code> from the file <code>epi_models/__main__.py</code>.
This will require a slight modification to our <code>__main__.py</code>
file. All that’s necessary is to move everything from the script into a
function <code>main()</code> that takes no arguments, and then to call
<code>main()</code> at the bottom of the script:</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: main.py</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Put the __main__ script here...</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>main()</span></code></pre>
</div>
<p>This will allow us to run our package as a script directly from the
command line</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install .</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> epi_models <span class="at">--help</span></span></code></pre>
</div>
<p>Note that we’ll still be able to run our code using the longer
form:</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> epi_models <span class="at">--help</span></span></code></pre>
</div>
<p>If we have multiple scripts in our package, these can all be given
invidual console scripts. However, these will also need to have a
function name as an entry point:</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">.</span><span class="dt">scripts</span><span class="kw">]</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="dt">epi_models</span> <span class="op">=</span> <span class="st">"epi_models.__main__:main"</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="dt">epi_models_sir</span> <span class="op">=</span> <span class="st">"epi_models.plotting.plot_SIR:main"</span></span></code></pre>
</div>
<p>So how do these scripts work? When we activate a virtual environment,
a new entry is added to our <code>PATH</code> environment variable
linking to <code>/path/to/my/env/bin/</code>:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PATH</span> = <span class="st">"/path/to/my/env/bin:</span><span class="va">${PATH}</span><span class="st">"</span></span></code></pre>
</div>
<p>After installing our console scripts, we can find a new file in this
directory with the name we assigned to it. For example,
<code>/path/to/my/env/bin/epi_models</code>:</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/path/to/my/env/bin/python3</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> epi_models.__main__ <span class="im">import</span> main</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    sys.argv[<span class="dv">0</span>] <span class="op">=</span> re.sub(<span class="vs">r'(-script\.pyw|\.exe)?$'</span>, <span class="st">''</span>, sys.argv[<span class="dv">0</span>])</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    sys.exit(main())</span></code></pre>
</div>
<p>Installing our project has automatically created a new Python file
that can be run as a command line script due to the hash-bang
(<code>#!</code>) on the top line, and all it does it import our main
function and run it. As it’s contained with the <code>bin/</code>
directory of our Python environment, it’s available for use as long
we’re using that environment, but as soon as we call
<code>deactivate</code>, it is removed from our <code>PATH</code>.</p>
</section><section id="setting-dependency-versions"><h2 class="section-heading">Setting Dependency Versions<a class="anchor" aria-label="anchor" href="#setting-dependency-versions"></a>
</h2>
<hr class="half-width">
<p>Earlier, when setting <code>dependencies</code> in our
<code>pyproject.toml</code>, we chose to specify a minimum requirement
for <code>numpy</code>, but not for <code>pyyaml</code>:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"numpy &gt;= 1.20"</span><span class="op">,</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pyyaml"</span><span class="op">,</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>This indicates that <code>pip</code> should install any version of
<code>numpy</code> greater than 1.20, but that any version of
<code>pyyaml</code> will do. If our installed <code>numpy</code> version
is less than 1.20, or if it isn’t installed at all, <code>pip</code>
will upgrade to the latest version that’s compatible with the rest of
our installed packages and our Python version. We’ll cover software
versioning in more detail in the <a href="05-publishing.html">lesson on
publishing</a>, but now we’ll simply cover some ways to specify which
software versions we need:</p>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy &gt;= 1.20"</span>  <span class="co"># Must be at least 1.20</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy &gt; 1.20"</span>   <span class="co"># Must be greater than 1.20</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy == 1.20"</span>  <span class="co"># Must be exactly 1.20</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy &lt;= 1.20"</span>  <span class="co"># Must be 1.20 at most</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy &lt; 1.20"</span>   <span class="co"># Must be less than 1.20</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy == 1.*"</span>   <span class="co"># Must be any version 1</span></span></code></pre>
</div>
<p>If we separate our clauses with commas, we can combine these
requirements:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># At least 1.20, less than 1.22, and not the release 1.21.3</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy =&gt; 1.20, &lt; 1.22, != 1.21.3"</span></span></code></pre>
</div>
<p>A useful shorthand is the ‘compatible release’ clause:</p>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy ~= 1.20"</span>  <span class="co"># Must be a release compatible with 1.20</span></span></code></pre>
</div>
<p>This is equivalent to:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">"numpy &gt;= 1.20,  == 1.*"</span></span></code></pre>
</div>
<p>That is, we require anything which is version 1, provided it’s
greater than 1.20. This would include version 1.25, but exlude version
2.0. We’ll come back to this later when we discuss <a href="05-publishing.html">publishing</a>.</p>
</section><section id="optional-dependencies"><h2 class="section-heading">Optional Dependencies<a class="anchor" aria-label="anchor" href="#optional-dependencies"></a>
</h2>
<hr class="half-width">
<p>Sometimes we might have dependencies that only make sense for certain
kind of user. For example, a developer of our library might need any
libraries we use to run unit tests or build documentation, but an end
user would not. These can be added as
<code>optional-dependencies</code>:</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">.</span><span class="dt">optional-dependencies</span><span class="kw">]</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="dt">test</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pytest &gt;= 5.0.0"</span><span class="op">,</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="dt">doc</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sphinx"</span><span class="op">,</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>These dependencies can be installed by adding the name of each
optional dependency group in square brackets after telling
<code>pip</code> what we want to install:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install .[test]     <span class="co"># Include testing dependencies</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install .[doc]      <span class="co"># Include documentation dependencies</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install .[test,doc] <span class="co"># Include all dependencies</span></span></code></pre>
</div>
</section><section id="additional-tools"><h2 class="section-heading">Additional Tools<a class="anchor" aria-label="anchor" href="#additional-tools"></a>
</h2>
<hr class="half-width">
<p>Some additional tools unrelated to package building also make use of
<code>pyproject.toml</code>. Their settings are typically set using
<code>[tool.*]</code> headings. For example, the tool <a href="https://pypi.org/project/black/" class="external-link"><code>black</code></a> which is
used to auto-format Python code can be configured here:</p>
<div class="codewrapper sourceCode" id="cb46">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">black</span><span class="kw">]</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="dt">line-length</span> <span class="op">=</span> <span class="dv">120</span></span></code></pre>
</div>
<p>Not all popular Python tools have adopted <code>pyproject.toml</code>
yet. Notably, the linter <a href="https://flake8.pycqa.org/en/latest/" class="external-link"><code>flake8</code></a>
cannot be configured this way, and users will instead need to use a
<code>.flake8</code> file (or one of a few alternative config
files).</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>We can configure our projects for <code>pip</code> installation by
setting up a <code>pyproject.toml</code> file.</li>
<li>Simple projects require very little to be added to this file, but
there are many optional extras we can add.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-04-history-of-packaging"><p>Content from <a href="04-history-of-packaging.html">Extra: A History of Python Build Tools</a></p>
<hr>
<p> Last updated on 2023-01-17 | 
        
        <a href="https://github.com/LiamPattinson/python-packaging/edit/main/episodes/04-history-of-packaging.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why have the ‘best practices’ for building and installing Python
packages changed so much of the years?</li>
<li>What problems has each new iteration solved?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the history of Python packaging</li>
<li>Understand what each method does when we install a package</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="introduction"><h2 class="section-heading">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>In the previous lesson, we showed how to install Python packages
using the file <code>prproject.toml</code>. However, if you ever find
yourself looking for online help on a Python packaging topic, you’ll
likely find a large number of alternative methods being recommended.
Some say you should use a file <code>setup.py</code>, while others
recommend a combination of <code>setup.cfg</code> and
<code>setup.py</code> – some even say to use both these and
<code>pyproject.toml</code>!</p>
<p>The reason for this conflicting information is that the Python
packaging ‘best practices’, as decided by the Python community, have
changed a number of times over the years. This lesson is optional, but
it will explain why some older tutorials recommend some methods over the
ones we’ve covered here. The intention here is not to present
alternative methods so that you can use them in new projects, but rather
to provide some context to the often confusing information out there,
and to help if you ever find yourself working on a project that hasn’t
yet updated to the latest systems.</p>
</section><section id="in-the-beginning-there-was-distutils"><h2 class="section-heading">In the beginning, there was <code>distutils</code><a class="anchor" aria-label="anchor" href="#in-the-beginning-there-was-distutils"></a>
</h2>
<hr class="half-width">
<p>First introduced with Python 2.2, <code>distutils</code> is the
official Python package that allows users to install and distribute
their own packages. However, it was deprecated in <a href="https://peps.python.org/pep-0632/" class="external-link">PEP 632</a>, having been
superceded by <code>setuptools</code>. The primary issue with
<code>distutils</code> is that it is strongly coupled to the user’s
Python version, so the developers found they could not implement some
features or fixes without breaking inter-version compatibility. There
were further complaints that <code>distutils</code> was not well
maintained or documented. Nowadays, it is recommended to use a
combination of <code>pip</code> and <code>setuptools</code> instead, but
it will be useful to briefly cover basic <code>distutils</code> usage so
that we can understand some of the design choices that would follow.</p>
<p>To use <code>distutils</code> to install a package, the user would
create a file <code>setup.py</code> and (optionally)
<code>requirements.txt</code> in the same directory as the top-level
package:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 setup.py<br> |____📜
requirements.txt<br> |____📦 epi_models<br>      |<br>      |____📜
__init__.py<br>      |____📜 __main__.py<br>      |<br>      |____📁
models<br>      |    |<br>      |    |____📜 __init__.py<br>
     |    |____📜 SIR.py<br>      |    |____📜 SEIR.py<br>
     |    |____📜 SIS.py<br>      |    |____📜 utils.py<br>      |<br>
     |____📁 plotting<br>           |<br>           |____📜
__init__.py<br>           |____📜 plot_SIR.py<br>           |____📜
plot_SEIR.py<br>           |____📜 plot_SIS.py<br></code></p>
<p>Note that the project directory name is the same as the package name
– this is a common project layout for Python projects, but we will see
later how to achieve alternative layouts.</p>
<p>The file <code>setup.py</code> should contain a script that describes
the package and some metadata about the author. A very simple one might
look like this:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: setup.py</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> distutils.core <span class="im">import</span> setup</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>setup(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"epi_models"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    version<span class="op">=</span><span class="st">"1.0"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Epidemiology modelling tools in Python"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    author<span class="op">=</span><span class="st">"Jordan Smith"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    author_email<span class="op">=</span><span class="st">"jsmith@email.net"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span><span class="st">"https://github.com/jsmith1234/epi_models"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    packages<span class="op">=</span>[<span class="st">"epi_models"</span>, <span class="st">"epi_models.models"</span>, <span class="st">"epi_models.plotting"</span>],</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre>
</div>
<p>To install, <code>setup.py</code> can be run as a script with the
argument <code>install</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 setup.py install</span></code></pre>
</div>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Installing by running <code>setup.py</code> as a script is highly
discouraged. Use <code>pip</code> instead!</p>
</div>
</div>
</div>
<p>This creates a ‘source distribution’ in a new directory
<code>./build</code>, and adds it to the current environment. We can see
how this works by reading the output written to the terminal:</p>
<pre class="result"><code>creating /path/to/my/env/lib/python3.8/site-packages/epi_models
copying build/lib/epi_models/__init__.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models
creating /path/to/my/env/lib/python3.8/site-packages/epi_models/models
copying build/lib/epi_models/models/utils.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/models
copying build/lib/epi_models/models/__init__.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/models
copying build/lib/epi_models/models/SEIR.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/models
copying build/lib/epi_models/models/SIR.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/models
copying build/lib/epi_models/models/SIS.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/models
creating /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting
copying build/lib/epi_models/plotting/__init__.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting
copying build/lib/epi_models/plotting/plot_SIS.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting
copying build/lib/epi_models/plotting/plot_SEIR.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting
copying build/lib/epi_models/plotting/plot_SIR.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting
copying build/lib/epi_models/__main__.py -&gt; /path/to/my/env/lib/python3.8/site-packages/epi_models
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/__init__.py to __init__.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/models/utils.py to utils.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/models/__init__.py to __init__.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/models/SEIR.py to SEIR.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/models/SIR.py to SIR.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/models/SIS.py to SIS.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting/__init__.py to __init__.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting/plot_SIS.py to plot_SIS.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting/plot_SEIR.py to plot_SEIR.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/plotting/plot_SIR.py to plot_SIR.cpython-38.pyc
byte-compiling /path/to/my/env/lib/python3.8/site-packages/epi_models/__main__.py to __main__.cpython-38.pyc</code></pre>
<p>After building a package in the <code>./build</code> directory, which
simply requires copying over all of our Python files into a special
directory structure, each file and directory is copied into the
<code>site-packages</code> directory in our virtual environment. This
directory is located on Python’s import path, which we can view by
calling:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> sys</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">print</span>(sys.path)</span></code></pre>
</div>
<pre class="result"><code>['', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/path/to/my/env/lib/python3.8/site-packages']</code></pre>
<p>We therefore do not need to modify the <code>PYTHONPATH</code>
environment variable in order to import these modules from anywhere on
our system.</p>
<p>The second stage of installing our package is to compile each file
into Python bytecode. This is a low-level representation of our code
which is understood by the Python virtual machine on our system, and
ultimately all Python code is reduced to this form before being imported
or run. By pre-compiling each of our modules, any future imports will be
much faster.</p>
<p>A significant downside of <code>distutils</code> is that there is no
way to safely uninstall a project once it has been installed, and
instead the user must manually remove the package from their
<code>site-packages</code> folder.</p>
<p><code>distutils</code> also contains many other tools for adding
language extensions written in C. However, it does not allow users to
specify dependencies, and these are instead expected to be listed in the
file <code>requirements.txt</code>:</p>
<pre><code><span><span class="va">matplotlib</span><span class="op">&gt;=</span><span class="fl">3.6</span></span>
<span><span class="va">pyyaml</span><span class="op">&gt;=</span><span class="fl">6.0</span></span></code></pre>
<p>The user can install the requirements by calling:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip <span class="at">-r</span> requirements.txt</span></code></pre>
</div>
<p>It is not recommended to use <code>distutils</code> for new projects,
and it will be removed from standard Python distributions starting from
version 3.12. Listing dependencies in <code>requirements.txt</code> is
also no longer required.</p>
</section><section id="setuptools-and-egg-files"><h2 class="section-heading">
<code>setuptools</code> and <code>egg</code> files<a class="anchor" aria-label="anchor" href="#setuptools-and-egg-files"></a>
</h2>
<hr class="half-width">
<p><code>setuptools</code> is not part of the core Python library, but
it has become the <em>de facto</em> standard build tool. Originally, it
added extra functionality on top of <code>distutils</code> using a
complicated collection of subclasses and monkeypatching, and it offered
better support across multiple Python versions. It has since superceded
<code>distutils</code> entirely.</p>
<p>Using <code>setuptools</code>, it is possible to use
<code>setup.py</code> to define a package in much the same way as
<code>distutils</code>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: setup.py</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> setuptools <span class="im">import</span> setup</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>setup(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"epi_models"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    version<span class="op">=</span><span class="st">"1.0"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Epidemiology modelling tools in Python"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    author<span class="op">=</span><span class="st">"Jordan Smith"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    author_email<span class="op">=</span><span class="st">"jsmith@email.net"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span><span class="st">"https://github.com/jsmith1234/epi_models"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    packages<span class="op">=</span>[<span class="st">"epi_models"</span>, <span class="st">"epi_models.models"</span>, <span class="st">"epi_models.plotting"</span>],</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    install_requires<span class="op">=</span>[<span class="st">"matplotlib&gt;=3.6"</span>, <span class="st">"pyyaml&gt;=6.0"</span>],</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre>
</div>
<p>Note the addition of an extra field, <code>install_requires</code>.
This allows us to specify the dependencies without the extra file
<code>requirements.txt</code>, and these libraries will be installed
alongside our package when we install it.</p>
<p>We can run this file just as we did with <code>distutils</code>:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 setup.py install</span></code></pre>
</div>
<p>Again, this will create a new directory <code>./build</code>, but it
will also create a directory <code>./dist</code> containing a file with
a name such as <code>epi_models-1.0-py3.8.egg</code>, and a directory
<code>epi_models.egg-info</code> that contains metadata files describing
our project. The ‘egg’ file is a distributable package format used by
<code>setuptools</code>, and is essentially just a <code>.zip</code>
file containing our package with a name specifying its version and its
Python version compatibility. We can show this on Linux systems using
the <code>unzip</code> command line utility:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="co"># unzip the egg file, put the results in a new folder 'test'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unzip dist/epi_models-1.0-py3.8.egg <span class="at">-d</span> test</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="co"># See what's inside</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls test</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>EGG-INFO epi_models</code></pre>
</div>
<p>Inside the <code>.egg</code> file, we find a copy of the
<code>.egg-info</code> directory created earlier, and a copy of our
package. If we look inside this version of our package, we can also see
that each directory contains a <code>__pycache__</code>, with Python
bytecode <code>.pyc</code> files inside, meaning each file has been
pre-compiled. This is done to optimise the egg file, as they are
intended to be directly importable. However, it also means the egg file
is only compatible with some Python versions, so projects written to be
compatible with both Python 2 and Python 3 must have separate
<code>.egg</code> files for each Python version. Egg files have been
superseded by ‘wheel’ files, which we’ll discuss in the next lesson.</p>
<p>So what happens when we install with <code>setuptools</code> as
opposed to <code>distutils</code>? A clue can be found in some of the
text outputted when we installed:</p>
<pre class="result"><code>Adding epi-models 1.0 to easy-install.pth file</code></pre>
<p>If we look in our <code>site-packages</code> directory, we’ll see a
file <code>easy-install.pth</code>. This is a path configuration file,
denoted by the extension <code>*.pth</code>, and if any are found within
<code>site-packages</code> (or a number of other Python configuration
directories), any additional items listed in it will be added to
<code>sys.path</code> whenever Python is loaded up. If we look into this
file, we find:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat /path/to/my/env/lib/python3.8/site-packages/easy-install.pth</span></code></pre>
</div>
<pre class="result"><code><span><span class="va">.</span><span class="op">/</span><span class="va">epi_models</span><span class="op">-</span><span class="fl">1.0</span><span class="op">-</span><span class="va">py3.8.egg</span></span></code></pre>
<p>If we again check our <code>sys.path</code> variable in an
interactive session, we’ll see that this is located on the path. Python
is capable of running/importing zipped directories, so the egg file that
was created in <code>./dist</code> and copied to
<code>site-packages</code> will be used for any future imports.</p>
<p>Although there is still no way to uninstall using
<code>setup.py</code>, it is possible to remove a package installed this
way using pip:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip uninstall epi_models</span></code></pre>
</div>
</section><section id="using-pip-instead-of-running-setup.py"><h2 class="section-heading">Using <code>pip</code> instead of running <code>setup.py</code><a class="anchor" aria-label="anchor" href="#using-pip-instead-of-running-setup.py"></a>
</h2>
<hr class="half-width">
<p>The direct usage of <code>setup.py</code> is now discouraged. After
installing a package using <code>python3 setup.py install</code>, there
is no equivalent command to uninstall. It also tends to clutter the
user’s workspace by creating local <code>./build</code> and
<code>./dist</code> directories. Both of these problems can be solved
using <code>pip</code>, which also provides a number of further
benefits:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install .</span></code></pre>
</div>
<p>Alternatively, to ensure we’re using the right version of
<code>pip</code> on systems that have both Python 2 and Python 3
installed alongside each other, we may invoke <code>pip</code> as a
runnable package:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install .</span></code></pre>
</div>
<p>This will install the library to the current Python environment. It
can then be uninstalled using:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip uninstall epi_models</span></code></pre>
</div>
<p>When installing with <code>pip</code> instead of running
<code>setup.py</code>, no <code>./build</code> or <code>./dist</code>
directories are created, nor are any <code>.egg</code> files. Two lines
which are printed to screen during the install process explain what is
happening instead:</p>
<pre class="result"><code>Created wheel for epi-models: filename=epi_models-1.0-py3-none-any.whl size=4968 sha256=f876a8ce10a3b6a6d0261f4d739b1d78904153b4feaf2b37f83de60e4b9c2d36
Stored in directory: /tmp/pip-ephem-wheel-cache-_og4ywxd/wheels/d9/4d/ac/bbc1437fd83635787dd0fb8c3df8da61fc7b57f6eaa2b0d17b</code></pre>
<p>Instead of creating an egg file, a ‘wheel’ is created instead. We’ll
cover wheel files in more detail in the next lesson, but to summarise, a
wheel is very similar to an egg file except for two major
differences:</p>
<ul>
<li>The code within is not compiled to Python bytecode.</li>
<li>The name of the file contains more information regarding its
compatibility.</li>
</ul>
<p>The wheel is created in a temporary directory (<code>/tmp</code> on
most Linux systems) so that it doesn’t clutter up our workspace, and
when installing from a wheel, the file is unzipped within
<code>site-packages</code> and the code within is compiled to bytecode.
This is in contrast to egg files, which remain zipped at all times and
come with their code pre-compiled.</p>
<p>To aid code development, we can also create <em>editable
installs</em>, in which the user’s changes to the code are automatically
picked up and there is no need to reinstall:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install <span class="at">-e</span> .</span></code></pre>
</div>
<p>This works simply by adding the path of our working directory into
<code>easy-install.pth</code> within the <code>site-packages</code>
directory. It will also install any dependencies of the project as
normal.</p>
<p>As the usage of <code>setup.py</code> gained further criticism, even
when used alonside <code>pip</code>. As library writers were able to add
arbitrary code to this file, setup scripts often became very long and
confusing to understand for users. They could also contain potentially
dangerous (or even malicious) code that may not be apparent at first
glance. <code>distutils</code> had also supported an alternative method
of specifying package metadata using an additional file
<code>setup.cfg</code>, and in time this became the preferred
method.</p>
</section><section id="setup.cfg-as-a-declarative-config"><h2 class="section-heading">
<code>setup.cfg</code> as a ‘Declarative Config’<a class="anchor" aria-label="anchor" href="#setup.cfg-as-a-declarative-config"></a>
</h2>
<hr class="half-width">
<p>Instead of using <code>setup.py</code> to define our package
metadata, it is preferable to instead use the file
<code>setup.cfg</code>. Instead of being a runnable Python module, this
file is simply a config file that can be read using Python’s built-in
<code>configparser</code> tool. Its format is very similar to INI files
commonly used on Windows systems. It should be included at the very top
of a project, just like <code>setup.py</code>:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 setup.cfg<br> |____📜
setup.py<br> |____📦 epi_models<br>      |<br>      |____📜
__init__.py<br>      |____📜 __main__.py<br>      |____📁 models<br>
     |____📁 plotting<br></code></p>
<p><code>setup.py</code> is still present, but it can be reduced to a
very simple form:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: setup.py</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> setuptools <span class="im">import</span> setup</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>setup()</span></code></pre>
</div>
<p>The <code>setup.py</code> files we used earlier can be easily adapted
to a corresponding <code>setup.cfg</code>:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">INI<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode ini" tabindex="0"><code class="sourceCode ini"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">; file: setup.cfg</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[metadata]</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="dt">name </span><span class="ot">=</span><span class="st"> epi_models</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="dt">version </span><span class="ot">=</span><span class="st"> </span><span class="fl">1.0</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dt">description </span><span class="ot">=</span><span class="st"> Epidemiology modelling tools in Python</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="dt">author </span><span class="ot">=</span><span class="st"> Jordan Smith</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="dt">author_email </span><span class="ot">=</span><span class="st"> jsmith@email.net</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="dt">url </span><span class="ot">=</span><span class="st"> "https://github.com/jsmith1234/epi_models"</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="kw">[options]</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="dt">packages </span><span class="ot">=</span><span class="st"> find:</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="dt">install_requires </span><span class="ot">=</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="dt">    matplotlib &gt;</span><span class="ot">=</span><span class="st"> </span><span class="fl">3.6</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="dt">    pyyaml &gt;</span><span class="ot">=</span><span class="st"> </span><span class="fl">6.0</span></span></code></pre>
</div>
<p>Note that the values on the right hand side of each equals sign are
all intepretted as strings by default, and double quotes are only needed
to escape certain special characters. Values can stretch over a line
break by indenting the next line down. Comment lines start with either
<code>;</code> or <code>#</code>, and inline comments are not
allowed.</p>
<p>The benefit of using this file over <code>setup.py</code> is that the
number of possible operations is restricted. This prevents users from
writing overly complex <code>setup.py</code> files that include
arbitrary and potentially dangerous computations. This is also
beneficial from an automation standpoint, as it is easy for tools
besides <code>setuptools</code> to read <code>setup.cfg</code> and
deduce useful information about a package.</p>
<p>Note that in converting our <code>setup.py</code> to a
<code>setup.cfg</code>, we are no longer listing each package and
subpackage, and instead we are using the line:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">INI<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode ini" tabindex="0"><code class="sourceCode ini"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">packages </span><span class="ot">=</span><span class="st"> find:</span></span></code></pre>
</div>
<p>This instructs <code>setuptools</code> to detect packages itself. We
could instead specify this manually using:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">INI<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode ini" tabindex="0"><code class="sourceCode ini"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">packages </span><span class="ot">=</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="dt">    epi_models</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    epi_models.models</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="dt">    epi_models.plotting</span></span></code></pre>
</div>
<p>A common alternative project layout is to place the top-level package
in a directory <code>src</code>:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 setup.py<br> |____📜
setup.cfg<br> |____📁 src<br>      |<br>      |____📦 epi_models<br>
          |<br>           |____📜 __init__.py<br>           |____📜
__main__.py<br>           |____📁 models<br>           |____📁
plotting<br></code></p>
<p>Our <code>setup.cfg</code> file should be rewritten as follows:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">INI<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode ini" tabindex="0"><code class="sourceCode ini"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[options]</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">package_dir </span><span class="ot">=</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="ot">=</span><span class="st">src</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="dt">packages </span><span class="ot">=</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="dt">    epi_models</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="dt">    epi_models.models</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="dt">    epi_models.plotting</span></span></code></pre>
</div>
<p>We can also continue using <code>packages = find:</code> by adding an
extra heading to our config file:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">INI<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode ini" tabindex="0"><code class="sourceCode ini"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[options]</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="dt">package_dir </span><span class="ot">=</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="ot">=</span><span class="st">src</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="dt">packages </span><span class="ot">=</span><span class="st"> find:</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[options.packages.find]</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="dt">where </span><span class="ot">=</span><span class="st"> src</span></span></code></pre>
</div>
<div id="callout2" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout2"></a>
</h3>
<div class="callout-content">
<p>Recent versions of <code>setuptools</code> can handle either the
‘flat’ layout or the <code>src</code>-layout using just
<code>packages = find:</code>.</p>
</div>
</div>
</div>
<p>There are many additional ways to organise a project, and it is
possible to set package names to something other than the corresponding
directory name, but it is recommended to keep the directory structure of
your projects as close as possible to that of the Python package. See
the <a href="https://setuptools.pypa.io/en/latest/references/keywords.html" class="external-link">documentation
for <code>setuptools</code> keywords</a> for more information.</p>
</section><section id="pyproject.toml-and-circular-build-requirements"><h2 class="section-heading">
<code>pyproject.toml</code> and Circular Build Requirements<a class="anchor" aria-label="anchor" href="#pyproject.toml-and-circular-build-requirements"></a>
</h2>
<hr class="half-width">
<p>We saw in the previous sections that <code>setuptools</code> allows
library writers to specify the requirements of their packages and allow
users to automatically download and install dependencies. However, there
is always one requirement missing from this list:
<code>setuptools</code> itself! It would be useful if we could add
<code>setuptools</code> to our <code>install_requires</code>, but the
user already needs to have <code>setuptools</code> installed in order to
parse this field! In the era of <code>distutils</code>, this was not a
problem for Python developers, as <code>distutils</code> was shipped as
part of Python’s standard library.</p>
<p>The resolution to this problem came in <a href="https://peps.python.org/pep-0517/" class="external-link">PEP 517</a> and <a href="https://peps.python.org/pep-0518/" class="external-link">PEP 518</a>, which specifies
how to set build system requires within a new config file,
<code>pyproject.toml</code>. <code>setup.cfg</code> is understood by
<code>setuptools</code> (and possibly <code>distutils</code>), but
<code>pyproject.toml</code> is intended to be understood by <em>any</em>
Python build tool, current or future. This includes <code>pip</code> and
alternatives such as <code>flit</code> or <code>poetry</code>.</p>
<p>To specify our build system following <a href="https://peps.python.org/pep-0517/" class="external-link">PEP 517</a>/<a href="https://peps.python.org/pep-0518/" class="external-link">518</a>,
<code>pyproject.toml</code> should be added to our project at the same
level as <code>setup.py</code> and <code>setup.cfg</code>:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 pyproject.toml<br> |____📜
setup.py<br> |____📜 setup.cfg<br> |____📦 epi_models<br>      |<br>
     |____📜 __init__.py<br>      |____📜 __main__.py<br>      |____📁
models<br>      |____📁 plotting<br></code></p>
<p>At a minimum, it should contain the following:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">build-system</span><span class="kw">]</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">requires</span> <span class="op">=</span> <span class="op">[</span><span class="st">"setuptools &gt;= 61"</span><span class="op">]</span></span></code></pre>
</div>
<p>Following this, we may install our package using <code>pip</code>
without first having <code>setuptools</code> installed. If we have an
older version of <code>setuptools</code> installed, <code>pip</code>
will now fetch the latest version in an isolated virtual environment
prior to building our project.</p>
<p>If we try installing however, we may find the following warnings:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> pip install .</span></code></pre>
</div>
<pre class="result"><code>WARNING: Missing build requirements in pyproject.toml for file:///my/file/path.
WARNING: The project does not specify a build backend, and pip cannot fall back to setuptools without 'wheel'.</code></pre>
<p>This means that <code>pip</code> is falling back on default
behaviour, as we have not fully specified our build system. By default,
<code>pip</code> will use <code>setuptools</code> (more specifically,
the build backend <code>setuptools.build_meta:__legacy__</code>), and it
requires the additional package <code>wheel</code> (which we’ll discuss
further in the next lesson). To explicitly set our build system, we must
also provide a <code>build-backend</code>:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">build-system</span><span class="kw">]</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="dt">requires</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"setuptools &gt;= 65"</span><span class="op">,</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wheel &gt;= 0.38,</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="dt">build-backend</span> <span class="op">=</span> <span class="st">"setuptools.build_meta"</span></span></code></pre>
</div>
</section><section id="moving-to-pyproject.toml-only-builds"><h2 class="section-heading">Moving to <code>pyproject.toml</code>-only builds<a class="anchor" aria-label="anchor" href="#moving-to-pyproject.toml-only-builds"></a>
</h2>
<hr class="half-width">
<p>Following <a href="https://peps.python.org/pep-0517/" class="external-link">PEP 517</a>/<a href="https://peps.python.org/pep-0518/" class="external-link">518</a>, it was realised that
<code>pyproject.toml</code> and <code>setup.cfg</code> were both solving
similar problems, although <code>pyproject.toml</code> was to be a
standardised config file, while <code>setup.cfg</code> was
<code>setuptools</code> specific (although many other tools in the
Python ecosystem had also adopted the usage of <code>setup.cfg</code>).
Altenative build tools such as <code>poetry</code> and <code>flit</code>
opted to use <code>pyproject.toml</code> alone to define Python
packages, and this was eventually codified as a requirement for all
build tools in <a href="https://peps.python.org/pep-0621/" class="external-link">PEP
621</a>.</p>
<p>The aim of <a href="https://peps.python.org/pep-0621/" class="external-link">PEP 621</a> is
to standardise a set of ‘core’ metadata that any build tool should
recognise, such as <code>name</code>, <code>version</code>,
<code>description</code>, <code>authors</code>, etc. Tools may choose to
use their own synonyms for this metadata, and they may provide many more
options than the core set, but to be standards compliant they must
recognise the metadata of <a href="https://peps.python.org/pep-0621/" class="external-link">PEP 621</a> at a minimum.</p>
</section><section id="the-end-of-setup.py"><h2 class="section-heading">The end of <code>setup.py</code><a class="anchor" aria-label="anchor" href="#the-end-of-setup.py"></a>
</h2>
<hr class="half-width">
<p>With <a href="https://peps.python.org/pep-0621/" class="external-link">PEP 621</a> removing
the need for <code>setup.cfg</code>, one might expect that the older
<code>setup.py</code> could be removed too. However,
<code>setuptools</code> still required this file for some features to
work, including editable installs. With <a href="https://peps.python.org/pep-0660/" class="external-link">PEP 660</a>, the Python
community standardised a way to use wheel files to create editable
installs, and therefore the use of <code>setup.py</code> is no longer
required. However, this feature was only recently implemented in
<code>pip</code>, so users may need to upgrade if they wish to use this
feature:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="at">--upgrade</span> pip</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>The ‘best practices’ for Python packaging has changed a number of
times, and there are now many competing tools for accomplishing the same
task.</li>
<li>Be wary of information on this topic in online tutorials – not all
guides have been updated to use the most recent methods, and some advice
may no longer be relevant.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-05-publishing"><p>Content from <a href="05-publishing.html">Publishing our Python Packages</a></p>
<hr>
<p> Last updated on 2023-01-16 | 
        
        <a href="https://github.com/LiamPattinson/python-packaging/edit/main/episodes/05-publishing.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What services can we use to publish our software?</li>
<li>What steps must we take to accomplish this?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn how to version our software and create releases.</li>
<li>Learn how to publish our software on PyPi, the Python Packaging
Index.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="publishing-our-python-packages"><h2 class="section-heading">Publishing our Python Packages<a class="anchor" aria-label="anchor" href="#publishing-our-python-packages"></a>
</h2>
<hr class="half-width">
<p>Following our lesson on <a href="03-building-and-installing.html">building and installing</a>
Python packages, we should now have a package that can be installed
using <code>pip</code>. With just a little more work, we can now publish
our software on a few free online services: GitHub for source/version
control, and PyPI (the Python Packaging Index) for package hosting. The
latter is the default repository used by <code>pip</code>, so by hosting
our software there, other users will be able to install our software to
any machine of their choosing, and will be able to add it as a
dependency to their own projects.</p>
<p>Before discussing how to use these services, we’ll briefly cover
‘semantic versioning’: a method for adding meaningful versions to our
software containing compatibility information, and we’ll look at some of
the preparatory steps we should take before publishing our code.</p>
</section><section id="versions-and-releases"><h2 class="section-heading">Versions and Releases<a class="anchor" aria-label="anchor" href="#versions-and-releases"></a>
</h2>
<hr class="half-width">
<p>Users of our software will expect it to stay consistent over time. If
we were to suddenly rename a function, or change what arguments it
takes, this could break our external user’s code, which in turn could
break a third user’s software, etc.</p>
<p>A good solution to this problem is to use ‘semantic versioning’ for
our code. Using semanic versioning, we will periodically make a new
‘release’ of our code, each time updating its version number, and the
way we change the number informs our users of whether the changes to our
code will break compatibility. In its most basic form, semantic
versioning requires 3 numbers, separated by periods, i.e. 1.2.3. These
numbers stand for MAJOR.MINOR.PATCH, and are typically updated
right-to-left. The meaning of each number is:</p>
<ul>
<li>PATCH: We increment the patch number whenever we make an update that
doesn’t add or remove functionality. It can include things such as
backwards-compatible bug fixes, internal code restructuring, and
performance improvements.</li>
<li>MINOR: The minor version should be incremented whenever we add new
backwards-compatible features to our code. This can include the addition
of new functions and classes. Whenever we increment the minor version,
the patch version is reset to zero.</li>
<li>MAJOR: The major version should be incremented whenever we make a
change that breaks backwards compatibility. This could include changing
a function name or signature, or removing something from the public API.
It can also include changing a function’s behaviour in a significant
way. Whenever we increment the major version, both the minor version and
patch version should be reset to zero.</li>
</ul>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>Our contains the following function which gives the nth value of the
Fibonacci sequence:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fibonacci(n):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> n</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fibonacci(n<span class="op">-</span><span class="dv">1</span>) <span class="op">+</span> fibonacci(n<span class="op">-</span><span class="dv">2</span>)</span></code></pre>
</div>
<p>A user points out that this function causes an infinite loop if
provided with a negative number, so we change it to:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fibonacci(n):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be greater than or equal to 0"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> n</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fibonacci(n<span class="op">-</span><span class="dv">1</span>) <span class="op">+</span> fibonacci(n<span class="op">-</span><span class="dv">2</span>)</span></code></pre>
</div>
<p>If our software was version 2.3.4, and after this change we make a
new release, what should the new version number be?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>2.3.5. This change is backwards compatible, and doesn’t add any new
features. Instead, it simply fixes a bug.</p>
</div>
</div>
</div>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>Our algorithm isn’t very efficient, so we convert it to an iterative
algorithm:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fibonacci(n):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be greater than or equal to 0"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> n</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        last_two <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> n <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> <span class="bu">sum</span>(last_two)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            last_two[<span class="dv">0</span>] <span class="op">=</span> last_two[<span class="dv">1</span>]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            last_two[<span class="dv">1</span>] <span class="op">=</span> val</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            n <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> val</span></code></pre>
</div>
<p>If the previous version was 2.4.7, what should the new version
be?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>2.4.8. This change is backwards compatible, and doesn’t add any new
features. Instead, it just improves the performance of an existing
function.</p>
</div>
</div>
</div>
</div>
<div id="discussion3" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion3"></a>
</h3>
<div class="callout-content">
<p>We decide to add a new function to our code that gives the user the
full list of Fibonnaci numbers up to n:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fibonacci_list(n):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be greater than or equal to 0"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="dv">0</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> n <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            result.append(result[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> result[<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            n <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span></code></pre>
</div>
<p>If the previous version was 3.2.1, what should the new version
be?</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>3.3.0. We’ve added new features to our software, but we haven’t
changed the existing API. Therefore the minor version should be
incremented, and the patch number should be reset to zero.</p>
</div>
</div>
</div>
</div>
<div id="discussion4" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion4"></a>
</h3>
<div class="callout-content">
<p>Our users seem to prefer the <code>fibonacci_list</code> function, so
we decide to streamline our software by removing the original function
and renaming the new one <code>fibonacci</code>. If the previous version
was 3.4.5, what should the new version be?</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>4.0.0. By removing a function and changing the behaviour of another,
we have changed the public API in a manner which is not
backwards-compatible, and thus this might break our user’s code. We
therefore must increment the major number, and set both the minor and
patch numbers to zero.</p>
</div>
</div>
</div>
</div>
<p>We can add a version to our code by adding a <code>__version__</code>
to our top-most <code>__init__.py</code> file:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: epi_models/__init__.py</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>__version__ <span class="op">=</span> <span class="st">"1.2.3"</span></span></code></pre>
</div>
<p>This should also be reflected in our <code>pyproject.toml</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"1.2.3"</span></span></code></pre>
</div>
<p>To avoid having to keep these up-to-date manually, we’ll see later
how to automatically generate version info using <code>git</code>
tags.</p>
<p>Something to note about the major and minor version numbers is that
they only need to be updated if we change the <em>public API</em> of our
software. Therefore, if we change the behaviour of any functions or
classes intended for internal use, and the public API is unchanged we
only need to update the patch number.</p>
<p>We can indicate that a function, class, or variable is only intended
for internal use by prepending their name with an underscore
(i.e. <code>_myvar</code>, <code>_myfunc</code>, <code>_MyClass</code>).
Alternatively, if our project includes rich documentation, it may be
assumed that any objects that aren’t included in the user API are for
internal usage.</p>
<p>When we update the version of our software and release it publically,
we must not go back and change it, no matter how tempting the prospect
may be! Any fixes to our software may be perfomed by further releases,
usually via the patch number. If a vulnerability is found in an old
version of our software, it is permissible to return to it and release a
new patch. For example, the last version of Python 2 was version 2.7.18,
released in April 2020 – over a decade after the release of Python 3.0.
If we choose to stop supporting an old version of our software, and
therefore leave any vulnerabilities intact, this should be clearly
stated to our users, and they should be strongly advised to upgrade.</p>
<p>With this understanding of semantic versioning, we can now better
understand the behaviour of the ‘compatible release’ comparator
<code>~=</code> that we can use when setting dependencies in
<code>pyproject.toml</code>:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"numpy ~= 1.22.1"</span><span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>This means that we require a version of NumPy which has at least all
of the features of version 1.22.1, but maintains backwards compatibility
with it. <code>pip</code> will aim to get the highest possible version
that matches, so if a patch is released, it will get version 1.22.2. If
a new minor version is released, it will install 1.23.0. This continues
until the release of 2.0.0, which <code>pip</code> will not install.
This is equivalent to:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"numpy &gt;= 1.22.1, == 1.*"</span><span class="op">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="unstable-versions">Unstable Versions<a class="anchor" aria-label="anchor" href="#unstable-versions"></a>
</h3>
<p>Software with a major version of 0 is usually understood to be
‘unstable’. This means that anything can change between minor versions,
and that no promises can be made for backwards compatibility. This is
common for software in early stages of development, as the public API
may undergo many iterations before being finalised.</p>
<p>For your own software, it may be a good idea to keep the major number
at zero while you’re hashing out the public API and building a userbase.
Once you’ve settled on a stable API, or you’ve developed a sizable
userbase that won’t appreciate having to regularly update their code to
match your changing standards, you should consider setting your version
to 1.0.0.</p>
<p>If one of the dependencies in your project is still in an unstable
state, it may be a good idea to fix the minor version number instead of
using the compatible release comparator <code>~=</code>:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"unstable_project &gt;= 0.6.2, == 0.6.*"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>This is because the <code>~= 0.6</code> will get the latest release
from <code>0.6.0</code> to <code>1.0.0</code> (not included), but in
this case version 0.7 might break backwards compatibility with 0.6. Note
that some unstable projects may also break backwards compatibiliy in
their patch releases, as the regular rules don’t really apply. In these
cases, it may be better to fix even the patch number:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"unstable_project == 0.6.2"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="deprecation">Deprecation<a class="anchor" aria-label="anchor" href="#deprecation"></a>
</h3>
<p>It is considered good manners to give our users plenty of warning if
we plan to remove features that they might depend upon in our next major
release. For this reason, many developers will implement deprecation
warnings to alert users that the API is due to change in future, and
that they should update their code accordingly. For example:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfunc():</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    warnings.warn(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"myfunc is deprecated, and wil be removed in version 4"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">DeprecationWarning</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">42</span></span></code></pre>
</div>
<p>When adding deprecations to our code, we should update the minor
version, and include them in our changelog (discussed later). When we
follow through on our deprecations and remove features, this should also
be clearly stated in the changelog of our major release.</p>
</div>
<div class="section level3">
<h3 id="advanced-versioning">Advanced Versioning<a class="anchor" aria-label="anchor" href="#advanced-versioning"></a>
</h3>

<p>There are many more fine-grained versioning techniques that may be
employed as our projects grow in complexity, although these are not
universally adopted and may only be applicable to very large projects
with a detailed review process. The full list of version types accepted
by tools such as pip is listed in <a href="https://peps.python.org/pep-0440/" class="external-link">PEP 440</a>, while the formal
specification for semantic versioning can be found at <a href="https://semver.org" class="external-link">semver.org</a>. For example, we may provide
pre-release specifiers:</p>
<ul>
<li>1.1.0a0: The first alpha version of 1.1.0. This is intended for use
by developers of the project and (perhaps) a small group of users, and
may be subject to large changes. 1.1.0a0 comes after 1.0.N, but before
1.1.0. A second alpha version may be listed as 1.1.0a1.</li>
<li>1.1.0b0: The beta version of 1.1.0. This follows 1.1.0aN, and is
intended for use by a wider pool of users for further testing and
feedback. This is usually close to the finished product, but some large
changes remain possible.</li>
<li>1.1.0rc0: The release-candiate version of 1.1. Sometimes called a
‘preview’ version, it is not expected that further significant changes
will be made in version 1.1, but some small changes may be included. It
comes after 1.1.0bN, but before 1.1.0.</li>
</ul>
<p>The number following the pre-release specifier is optional, with no
number interpretted as 0 (i.e. <code>1.0.0a == 1.0.0a0</code>). A dot,
hyphen, or underscore separator is also allowed,
e.g. <code>1.0.0-a1</code>, <code>1.1.0.beta.3</code>,
<code>1.1.0-rc.2</code>. We may also make <em>post-releases</em> if we
wish to make minor edits after a release:</p>
<ul>
<li>1.1.0post0: An update after a release that does not change the
distributed software, e.g. a change in documentation or release notes.
It comes after 1.1.0 but before 1.1.1.</li>
</ul>
<p>Similarly, post-release specifiers may have dot, hypen or underscore
separators, and may exclude the trailing number. The use of ‘rev’ or ‘r’
in place of ‘post’ is also common. Note that a post-release is
<em>not</em> the appropriate place for a quick bug fix after a full
release – that should be an update to the patch number.</p>
<p>Finally, it is possible to create local versions in cases where a
developer has made progress on a new development but has not finalised
their work in a new release. If you use a tool such as Git to control
your versioning, it may automatically generate the local version. In
general, there is no ordering to local versions. A local version is
specified with a <code>+</code> followed by a dot-separated list of
numbers, letters, and hyphens, e.g. <code>1.1.0+001</code>,
<code>1.2.0-alpha-630-g60eca14</code>.</p>
</div>
</section><section id="preparing-to-publish"><h2 class="section-heading">Preparing to Publish<a class="anchor" aria-label="anchor" href="#preparing-to-publish"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="readme-files">README Files<a class="anchor" aria-label="anchor" href="#readme-files"></a>
</h3>
<p>Before sharing our software with the world, it is a good idea to let
others know what it is and how it works! A good README file should
explain what a project is for, how users can install it, and how to use
it. For example, we may use the following file <code>README.md</code>,
written using markdown.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">MARKDOWN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode markdown" tabindex="0"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="in">    # epi_models</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="in">    A collection of Python utilities for solving epidemiology problems.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="in">    ## Installation</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="in">    The project can be installed using \`pip\`:</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="in">    ```</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="in">    $ pip install epi_models</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="in">    ```</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="in">    To install from this repo:</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="in">    ```</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="in">    $ git clone github.com/username/epi_models</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="in">    $ cd epi_models</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="in">    $ pip install .</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="in">    ```</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="in">    ## Usage</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="in">    The project offers a command line interface, which can be used as</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="in">    follows:</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="in">    ```</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="in">    $ epi_models SIR input.yaml</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="in">    ```</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="in">    `SIR` can be exchanged for a model of your choice, and `input.yaml`</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="in">    is an input file with the following entries...</span></span></code></pre>
</div>
<p>This should be included at the top level of our project:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 pyproject.toml<br> |____📜
README.md<br> |____📦 epi_models<br>      |<br>      |____📜
__init__.py<br>      |____📜 __main__.py<br>      |____📁 models<br>
     |____📁 plotting<br></code></p>
<p>It should be included in our package metadata by adding the following
line in our <code>pyproject.toml</code>:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="dt">readme</span> <span class="op">=</span> <span class="st">"README.md"</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="licensing">Licensing<a class="anchor" aria-label="anchor" href="#licensing"></a>
</h3>
<p>It is important for our software to have a license so that any
potential users know what their rights are with regards to usage and
redistribution. This can also provide us with legal protections in some
cases.</p>
<p>There are several open source licenses available, and they can be
applied to our project simply by adding a <code>LICENSE</code>,
<code>LICENSE.txt</code>, or <code>LICENSE.md</code> file to the top
level of our project:</p>
<p><code> 📁 epi_models<br> |<br> |____📜 pyproject.toml<br> |____📜
README.md<br> |____📜 LICENSE.md<br> |____📦 epi_models<br>      |<br>
     |____📜 __init__.py<br>      |____📜 __main__.py<br>      |____📁
models<br>      |____📁 plotting<br></code></p>
<p>One of the simplest and most widely used licenses is the MIT License,
which is very permissive. It requires users of your software to retain
its copyright notice if they redistribute or modify it (or ‘substantial
portions’ of it), but otherwise allows users to do what they wish. It
also ensures the author is not liable for anything the users do with
their software:</p>
<pre><code>MIT License

Copyright (c) [year] [fullname]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</code></pre>
<p>Information on alternative open source licenses can be found at <a href="https://choosealicense.com/" class="external-link">choosealicense.com</a>. Note that
your choice of license may be determined by your dependencies. For
example, if your code uses software licensed under the GNU GPLv3.0
license, it too should be licensed under GPLv3.0.</p>
<p>We should include our license in our <code>pyproject.toml</code> file
as follows:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">license</span> <span class="op">=</span> <span class="op">{</span><span class="dt">file</span><span class="op"> =</span> <span class="st">"LICENSE.md"</span><span class="op">}</span></span></code></pre>
</div>
<p>We can instead simply state the name of the license:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">license</span> <span class="op">=</span> <span class="op">{</span><span class="dt">text</span><span class="op"> =</span> <span class="st">"MIT License"</span><span class="op">}</span></span></code></pre>
</div>
</div>
</section><section id="publishing-our-software-on-github"><h2 class="section-heading">Publishing our Software on GitHub<a class="anchor" aria-label="anchor" href="#publishing-our-software-on-github"></a>
</h2>
<hr class="half-width">
<p><code>git</code> is a powerful version control tool that allows us to
track changes to our source code over time. This lesson is not the place
for teaching how to use <code>git</code>, but it is highly recommended
that you use it for managing your Python projects.</p>
<p>GitHub is an online service for hosting software projects using
<code>git</code>, and it is a great way to share our code and
collaborate with others.</p>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>GitHub is not the only service you can use for hosting your source
code. GitLab and BitBucket are popular alternatives.</p>
</div>
</div>
</div>
<p>Once our code is hosted on GitHub, we can create releases and assign
them a tag. This tag should be the version number of the release. We
will see later how to use GitHub Actions to automatically publish our
code on other services whenever a new release is created.</p>
<p>Whenever we make new releases of our code, we should write a detailed
changelog that describes all of the changes since the last version. This
should include new features, bug fixes, removals, and deprecations. A
good changelog document should include all code changes in reverse
chronological order (so the latest changes should be first in the list),
and should credit anybody who contributed to the code.</p>
<p>With our code hosted on GitHub, it is possible for others to install
it using <code>pip</code>:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="st">"git+https://github.com/user/project"</span></span></code></pre>
</div>
<p>However, this will simply get the latest commit to the main branch,
which may be a work-in-progress and not a true release. We can specify a
particular release by providing the version number after an
<code>@</code> sign:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="st">"git+https://github.com/user/project@1.2.3"</span></span></code></pre>
</div>
<p>Note that we can also supply a branch name, or a commit hash
here:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="st">"git+https://github.com/user/project@branch"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="st">"git+https://github.com/user/project@1a2b3c4"</span></span></code></pre>
</div>
<p>Projects hosted on GitHub can also be added to dependencies in
<code>pyproject.toml</code> as so:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mypkg @ git+https://github.com/user/mypkg@1.2.3"</span><span class="op">,</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>However, it is relatively slow for <code>pip</code> to install in
this way, as it must clone the whole repository. We can instead install
from a snapshot by pointing <code>pip</code> towards an archived
<code>.zip</code>:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install <span class="st">"https://github.com/user/project/archive/1.2.3.zip"</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mypkg @ https://github.com/user/mypkg/archive/1.2.3.zip"</span><span class="op">,</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>However, this is still slower than installing from a dedicated Python
package repository such as PyPI, which hosts pre-built <code>.whl</code>
files, and it only allows our users to specify a singular version of our
code. This means that they may miss out on crucial patch releases. In
general, it is a good idea to use GitHub to host our source code and to
manage its development, and to use a service like PyPI to host packages
that our users can install.</p>
<div class="section level3">
<h3 id="consistent-versioning-with-setuptools-scm">Consistent Versioning with <code>setuptools-scm</code>
<a class="anchor" aria-label="anchor" href="#consistent-versioning-with-setuptools-scm"></a>
</h3>
<p>An issue with using GitHub to create new releases is that the project
version can easily become desynced. The version should be specified in
three places:</p>
<ul>
<li>
<code>git</code> tags, determined by releases on GitHub</li>
<li>The <code>version</code> field in <code>pyproject.toml</code>
</li>
<li>
<code>__version__</code> in our <code>__init__.py</code>
</li>
</ul>
<p>It is possible to have all three determined by <code>git</code> tags
using <code>setuptools-scm</code>. This can be set as a requirement of
the build system:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">build-system</span><span class="kw">]</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="dt">requires</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"setuptools &gt;= 65"</span><span class="op">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"setuptools_scm[toml]"</span><span class="op">,</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wheel"</span><span class="op">,</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="dt">build-backend</span> <span class="op">=</span> <span class="st">"setuptools.build_meta"</span></span></code></pre>
</div>
<p>With this, we no longer need to provide an entry for
<code>project.version</code>, and instead should add:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"epi_models"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># version = "1.2.3" # no longer needed!</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="dt">dynamic</span> <span class="op">=</span> <span class="op">[</span><span class="st">"version"</span><span class="op">]</span></span></code></pre>
</div>
<p>Following this, we should the following section elsewhere in
<code>pyproject.toml</code>:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">setuptools_scm</span><span class="kw">]</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="dt">write_to</span> <span class="op">=</span> <span class="st">"epi_models/_version.py"</span></span></code></pre>
</div>
<p>Now, when we install or build the project,
<code>setuptools-scm</code> will create a new file
<code>_version.py</code> inside of our built package. If our git tag is
<code>1.2.3</code>, this will contain:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file generated by setuptools_scm</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># don't change, don't track in version control</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>__version__ <span class="op">=</span> version <span class="op">=</span> <span class="st">'1.2.3'</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>__version_tuple__ <span class="op">=</span> version_tuple <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span></code></pre>
</div>
<p>This can be retrieved at runtime by adding the following to
<code>__init__.py</code>:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: __init__.py</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib.metadata <span class="im">import</span> version, PackageNotFoundError</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    __version__ <span class="op">=</span> version(<span class="st">"epi_models"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> PackageNotFoundError:</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the package is not installed, don't add a version</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code></pre>
</div>
<p>Note that <code>importlib.metadata</code> was added to the standard
Python library in version 3.8. Earlier versions will need to instead
load <code>importlib_metadata</code>:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: __init__.py</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> importlib.metadata <span class="im">import</span> version, PackageNotFoundError</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> importlib_metadata <span class="im">import</span> version, PackageNotFoundError</span></code></pre>
</div>
<p>We can add this to our <code>pyproject.toml</code> as follows:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'</span><span class="vs">importlib_metadata; python_version &lt; "3.8"</span><span class="st">'</span><span class="op">,</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>Now, our Git tags, <code>__version__</code> variable, and
<code>pyproject.toml</code> <code>version</code> will all refer to the
same place, and there is much less chance of them accidentally falling
out-of-sync.</p>
</div>
</section><section id="publishing-our-software-on-pypi"><h2 class="section-heading">Publishing our Software on PyPI<a class="anchor" aria-label="anchor" href="#publishing-our-software-on-pypi"></a>
</h2>
<hr class="half-width">
<p><a href="https://pypi.org" class="external-link">PyPI</a>, the Python Packaging Index, is
the official package repository for the Python community. It is
equivalent to CRAN, used for the R programming language. This is the
repository that <code>pip</code> uses when we install remote packages
from the command line. It is recommended to upload packages here if we
want our projects to reach a wider audience.</p>
<figure><img src="fig/pypi.png" alt="The Python Packaging Index" class="figure mx-auto d-block"><figcaption>PyPI_screenshot</figcaption></figure><p>To begin, you will need to create an account on <a href="https://pypi.org" class="external-link">PyPI</a> and its sister-site, <a href="https://test.pypi.org" class="external-link">TestPyPI</a> – the latter is used to check
that our packages have been uploaded and set up properly before
committing to the standard repository.</p>
<p>To help people find our project after it’s uploaded, we should add
some keywords they can search for. We can also add ‘classifiers’ that
categorise our project and describe its intended audience. A list of
possible classifiers are available on the <a href="https://pypi.org/classifiers" class="external-link">PyPI website</a>. These should be
added to our <code>pyproject.toml</code>:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># keywords should contain search terms so users can</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># find our project</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="dt">keywords</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epimediology"</span><span class="op">,</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"virology"</span><span class="op">,</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SIR"</span><span class="op">,</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SEIR"</span><span class="op">,</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Compartmental"</span><span class="op">,</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Model"</span><span class="op">,</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Classifiers are a standard set of categories for</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># our project, including which level of development</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co"># we're at, who our intended audience is, which</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co"># license we're using, etc.</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="dt">classifiers</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Development Status :: 3 - Alpha"</span><span class="op">,</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Intended Audience :: Science/Research"</span><span class="op">,</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"License :: OSI Approved :: MIT License"</span><span class="op">,</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Natural Language :: English"</span><span class="op">,</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Operating System :: OS Independent"</span><span class="op">,</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Programming Language :: Python :: 3.8"</span><span class="op">,</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Topic :: Scientific/Engineering"</span><span class="op">,</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="wheels">
<code>wheels</code><a class="anchor" aria-label="anchor" href="#wheels"></a>
</h3>
<p>When we install packages using <code>pip</code>, it first creates a
‘wheel’ file. For example</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd epi_models</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install .</span></code></pre>
</div>
<pre class="result"><code>... installs dependencies ...

Building wheels for collected packages: epi-models
  Building wheel for epi-models (pyproject.toml) ... done
  Created wheel for epi-models: filename=epi_models-0.1.0-py3-none-any.whl size=5378 sha256=005bcad72e7f6cc773f4180960e402e3bdbdf0fcb6fb683a019d9521775edfc8
  Stored in directory: /tmp/pip-ephem-wheel-cache-69r0h48p/wheels/d9/4d/ac/bbc1437fd83635787dd0fb8c3df8da61fc7b57f6eaa2b0d17b
Successfully built epi-models
Installing collected packages: epi-models
Successfully installed epi-models-0.1.0</code></pre>
<p>The installation goes through several steps:</p>
<ul>
<li>
<code>pip</code> analyses our package and creates a
<code>*.whl</code> file.</li>
<li>The <code>*.whl</code> file is stored in a temporary directory.</li>
<li>The package is installed to our system from the <code>*.whl</code>
file.</li>
</ul>
<p>After installation, we can find our installed package at
<code>/path/to/my/env/lib/python3.8/site-packages/epi_models</code>, and
within we’ll find that every file has been compiled to Python bytecode,
contained within <code>__pycache__</code> directories:</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls /path/to/my/env/lib/python3.8/site-packages/epi_models</span></code></pre>
</div>
<pre class="result"><code>__init__.py __main__.py models plotting __pycache__</code></pre>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls /path/to/my/env/lib/python3.8/site-packages/epi_models/__pycache__</span></code></pre>
</div>
<pre class="result"><code>__init__.cpython-38.pyc __main__.cpython-38.pyc</code></pre>
<p>Python bytecode is a simpler and lower level language that is
understood by the Python Virtual Machine (PVM). The Python interpretter
always converts our code to bytecode before running it, and Python will
also compile modules to bytecode when we <code>import</code> them. By
precompiling our modules, it will be much faster to import and run
them.</p>
<p>So what is a wheel file, and how does it help with this process?</p>
<p>A wheel is a standard package distribution format, defined in <a href="https://peps.python.org/pep-0427/" class="external-link">PEP 427</a>. It is essentially
a <code>*.zip</code> file containing our package contents with a
descriptive name. When we installed our package above it created the
following wheel file:</p>
<pre><code>epi_models-0.1.0-py3-none-any.whl</code></pre>
<p>The filename has seveal components separated by hyphens. In order,
these are:</p>
<ul>
<li>The package name</li>
<li>The package version</li>
<li>Language implementation, e.g. <code>py3</code>, <code>py27</code>,
<code>py2</code>. Packages that are compatible with any Python version
will be <code>py2.py3</code>. Packages that are only compatible with a
particular Python implementation, such as CPython, may be listed
<code>cpy38</code>.</li>
<li>The ABI tag, which stands for ‘Application Binary Interface’. This
specifies the binary compatibility of the CPython API,
e.g. <code>abi3</code>. This won’t be relevant unless you’re
distributing compiled extensions written in C, and will be
<code>none</code> if your package is pure Python. This is beyond the
scope of these lessons.</li>
<li>Platform tag, which specifies which operating system your package is
compatible with. <code>any</code> means it will run on Windows, Mac or
Linux, while it may say something like <code>macosx_10_9_x86_64</code>
if it includes compiled C extensions for Mac OSX 10.9 on an x86_64
architecture. The <code>manylinux</code> tag encompasses many different
popular Linux distros.</li>
</ul>
<p>When we upload our package to PyPI, we will do so in the form of a
wheel file, which contains all Python files in our package along with
any compiled binaries for extensions written in C. When a wheel file is
installed, Python files are compiled to bytecode, and the package is
installed to the <code>site-packages</code> of our environment.</p>
</div>
<div class="section level3">
<h3 id="build-and-twine">
<code>build</code> and <code>twine</code>
<a class="anchor" aria-label="anchor" href="#build-and-twine"></a>
</h3>
<p>So how do we create a wheel file to upload? The standard tool used to
create wheel files is <code>build</code>:</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install build</span></code></pre>
</div>
<p>As we already have a <code>pyproject.toml</code>, <code>build</code>
has everything it needs to create a wheel file. It can be called simply
using</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> build</span></code></pre>
</div>
<p>This will create a new directory <code>.dist/</code> containing the
following:</p>
<p><code> 📁 dist<br> |<br> |____📜
epi_models-0.1.0-py3-none-any.whl<br> |____📜
epi_models-0.1.0.tar.gz<br></code></p>
<p>We can see the contents of the <code>.whl</code> file by unzipping
it:</p>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd dist</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> unzip dist/epi_models-0.1.0-py3-none-any.whl</span></code></pre>
</div>
<p>We’ll see that it contains our package along with a second directory
<code>epi_models-0.1.0.dist-info</code>, which contains package metadata
such as our license and README file. Note that we should remove the
unzipped directories before the upload stage.</p>
<p>The second file <code>build</code> created is a <code>.tar.gz</code>
file – a gzip compressed tarball. This is a ‘source distribution’, which
is used as a backup by <code>pip</code> if it can’t find a suitable
wheel file to install.</p>
<p>The tool for uploading our package to PyPI is <code>twine</code>:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install twine</span></code></pre>
</div>
<p>We can check that our package is well-formed by running
<code>twine check</code>:</p>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> twine check dist/<span class="pp">*</span></span></code></pre>
</div>
<p>If this returns that the package is okay, we can test the
distribution of our package by uploading to TestPyPI:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> twine upload <span class="at">--repository</span> testpypi dist/<span class="pp">*</span></span></code></pre>
</div>
<p>After checking that everything looks right on TestPyPI, we may
proceed with installing our package to PyPI:</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> twine upload dist/<span class="pp">*</span></span></code></pre>
</div>
<p>That’s all we need! Users will then be able to install our package to
any machine by calling the following:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install epi_models</span></code></pre>
</div>
<p>Similarly, it can be included as a dependency to other Python
projects:</p>
<div class="codewrapper sourceCode" id="cb46">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epi_models"</span><span class="op">,</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
<p>As we continue to develop our software, we should upload each new
version to PyPI. Our users will then be able to request a particular
version:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">TOML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode toml" tabindex="0"><code class="sourceCode toml"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># file: pyproject.toml</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">project</span><span class="kw">]</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="dt">dependencies</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epi_models ~= 1.2"</span><span class="op">,</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="automating-package-publishing-with-github-actions">Automating Package Publishing with GitHub Actions<a class="anchor" aria-label="anchor" href="#automating-package-publishing-with-github-actions"></a>
</h3>
<p>We saw earlier how to ensure that the version of our package was
stored only in the Git tags. We can similarly set up our GitHub project
to automatically publish our package whenever we make a new release. We
can use GitHub Actions for this, which is a service used for continuous
integration. It can achieve tasks such as:</p>
<ul>
<li>Automatically run tests on a variety of platforms each time a new
commit is pushed or version is published.</li>
<li>Enforce a code style automatically.</li>
<li>Publish work on each release.</li>
</ul>
<p>GitHub Actions are controlled using a YAML file. Though the full
specification is beyond the scope of this course, the following file
will cause GitHub to automatically upload our package to PyPI with each
new release:</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Provide a name for the workflow</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload Python Package</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Tell GitHub when to run the action</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This will run every time a new release is published</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">release</span><span class="kw">:</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">types</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">published</span><span class="kw">]</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy</span><span class="kw">:</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">    # Run the workflow on the latest Ubuntu version</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co">      # This will checkout our GitHub project and enter</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co">      # the directory</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co">      # This will set up a Python environment</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v2</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.x'</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="co">      # Here we update pip to the latest version and</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="co">      # install 'build'. We won't need 'twine' here.</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>          pip install build</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="co">      # Here we run build to create a wheel and a</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="co">      # .tar.gz source distribution.</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build package</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> python -m build --sdist --wheel</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="co">      # Finally, we use a pre-defined action to publish</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="co">      # our package in place of twine.</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Publish package</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> pypa/gh-action-pypi-publish@release/v1</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">user</span><span class="kw">:</span><span class="at"> __token__</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.PYPI_API_TOKEN }}</span></span></code></pre>
</div>
<p>This should be included in the file
<code>.github/workflows/publish.yml</code>, where the
<code>.github</code> directory is located at the top level of our
project (at the same level as <code>pyproject.toml</code>). In order for
this to work, we’ll need to set up a <code>PYPI_DEPLOYMENT_TOKEN</code>
in the ‘secrets’ section of our project’s GitHub settings. A guide to
doing this may be found on the <a href="https://pypi.org/help/#apitoken" class="external-link">PyPI website</a>.</p>
<div id="callout2" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout2"></a>
</h3>
<div class="callout-content">
<p>You should <em>never</em> push sensitive information such as
passwords directly to your GitHub projects!</p>
</div>
</div>
</div>
<p>With this set up, our projects will be automatically pushed to PyPI
each time we make a new release.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Versioning our projects is important so that our users know what’s
compatible.</li>
<li>GitHub is a powerful service for hosting our projects and managing
their development.</li>
<li>Each new release of our packages should be uploaded to PyPI using
<code>build</code> and <code>twine</code>.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/LiamPattinson/python-packaging/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
        
        
        | <a href="https://github.com/LiamPattinson/python-packaging/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/LiamPattinson/python-packaging/" class="external-link">Source</a></p>
				<p><a href="https://github.com/LiamPattinson/python-packaging/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:liam.pattinson@york.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.11.3" class="external-link">sandpaper (0.11.3)</a>,
        <a href="https://github.com/carpentries/pegboard/tree/0.4.2" class="external-link">pegboard (0.4.2)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.2.13" class="external-link">varnish (0.2.13)</a>.</p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://LiamPattinson.github.io/python-packaging/aio.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://LiamPattinson.github.io/python-packaging/aio.html",
  "identifier": "https://LiamPattinson.github.io/python-packaging/aio.html",
  "dateCreated": "2023-01-17",
  "dateModified": "2023-01-17",
  "datePublished": "2023-01-17"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

